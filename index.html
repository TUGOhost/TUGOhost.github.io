<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>TUGOhost</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="TUGOhost">
<meta property="og:url" content="http://tugohost.github.io.com/index.html">
<meta property="og:site_name" content="TUGOhost">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="TUGOhost">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="TUGOhost" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">TUGOhost</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://TUGOhost.github.io.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-KUbuntu 20环境配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/06/KUbuntu%2020%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="dt-published" datetime="2022-10-06T13:46:25.000Z" itemprop="datePublished">2022-10-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/06/KUbuntu%2020%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">KUbuntu20 环境配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="KUbuntu20-环境配置"><a href="#KUbuntu20-环境配置" class="headerlink" title="KUbuntu20 环境配置"></a>KUbuntu20 环境配置</h1><h2 id="安装-proxychains"><a href="#安装-proxychains" class="headerlink" title="安装 proxychains"></a>安装 proxychains</h2><p><code>sudo apt-get install proxychains-ng</code></p>
<p>修改<code>/etc/proxychains4.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ProxyList]</span><br><span class="line"></span><br><span class="line"># add proxy here ...</span><br><span class="line"></span><br><span class="line"># meanwile</span><br><span class="line"></span><br><span class="line"># defaults set to &quot;tor&quot;</span><br><span class="line"></span><br><span class="line">socks5  192.168.65.1 1080</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装-IDE"><a href="#安装-IDE" class="headerlink" title="安装 IDE"></a>安装 IDE</h2><h3 id="vscode"><a href="#vscode" class="headerlink" title="vscode"></a>vscode</h3><blockquote>
<p>snap install code</p>
</blockquote>
<h3 id="android-studio"><a href="#android-studio" class="headerlink" title="android studio"></a>android studio</h3><blockquote>
<p>snap install android-studio –classic</p>
</blockquote>
<h3 id="clion"><a href="#clion" class="headerlink" title="clion"></a>clion</h3><blockquote>
<p>snap install clion –classic</p>
</blockquote>
<h3 id="pycharm-community"><a href="#pycharm-community" class="headerlink" title="pycharm-community"></a>pycharm-community</h3><blockquote>
<p>snap install pycharm-community –classic</p>
</blockquote>
<h3 id="intellij-idea-community"><a href="#intellij-idea-community" class="headerlink" title="intellij-idea-community"></a>intellij-idea-community</h3><blockquote>
<p>snap install intellij-idea-community –classic</p>
</blockquote>
<h2 id="IDA-Pro-with-Wine"><a href="#IDA-Pro-with-Wine" class="headerlink" title="IDA Pro with Wine"></a>IDA Pro with Wine</h2><p><a target="_blank" rel="noopener" href="https://wiki.winehq.org/Ubuntu_zhcn">https://wiki.winehq.org/Ubuntu_zhcn</a></p>
<p><a target="_blank" rel="noopener" href="https://debugwar.com/article/activate-IDAPython-with-wine-IDA-under-linux">https://debugwar.com/article/activate-IDAPython-with-wine-IDA-under-linux</a></p>
<p>for Kubuntu 20 install winehq</p>
<blockquote>
<p>sudo dpkg –add-architecture i386</p>
</blockquote>
<blockquote>
<p>sudo proxychains wget -nc -O &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;winehq-archive.key <a target="_blank" rel="noopener" href="https://dl.winehq.org/wine-builds/winehq.key">https://dl.winehq.org/wine-builds/winehq.key</a></p>
</blockquote>
<blockquote>
<p>sudo proxychains wget -NP &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F; <a target="_blank" rel="noopener" href="https://dl.winehq.org/wine-builds/ubuntu/dists/focal/winehq-focal.sources">https://dl.winehq.org/wine-builds/ubuntu/dists/focal/winehq-focal.sources</a></p>
</blockquote>
<blockquote>
<p>sudo proxychains apt update</p>
</blockquote>
<blockquote>
<p>sudo proxychains apt install –install-recommends winehq-stable</p>
</blockquote>
<p>ida python env</p>
<p><a target="_blank" rel="noopener" href="https://www.python.org/ftp/python/3.10.2/python-3.10.2-embed-amd64.zip">https://www.python.org/ftp/python/3.10.2/python-3.10.2-embed-amd64.zip</a></p>
<blockquote>
<p>wine regedit</p>
</blockquote>
<p>ida python env pip</p>
<p><a target="_blank" rel="noopener" href="https://bootstrap.pypa.io/get-pip.py">https://bootstrap.pypa.io/get-pip.py</a></p>
<blockquote>
<p>wine python.exe get_pip.py</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>wine python.exe -m pip install keystone-engine</p>
</blockquote>
<blockquote>
<p>wine python.exe -m pip install six</p>
</blockquote>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="sip"><a href="#sip" class="headerlink" title="sip"></a>sip</h4><blockquote>
<p>ImportError: DLL load failed while importing sip: Module not found.</p>
</blockquote>
<p>pip 安装 PyQt5，但是还是会有这个问题，搜索发现</p>
<p><a target="_blank" rel="noopener" href="https://github.com/igogo-x86/HexRaysPyTools/issues/48">https://github.com/igogo-x86/HexRaysPyTools/issues/48</a></p>
<p><a target="_blank" rel="noopener" href="https://hex-rays.com/blog/ida-7-4-and-python-3-8/">https://hex-rays.com/blog/ida-7-4-and-python-3-8/</a></p>
<p><a target="_blank" rel="noopener" href="https://iosre.com/t/topic/21033/21">https://iosre.com/t/topic/21033/21</a></p>
<p>以上解决方法均不能解决问题，尝试使用 7.6 来替换 7.5。</p>
<h2 id="Typora"><a href="#Typora" class="headerlink" title="Typora"></a>Typora</h2><blockquote>
<p>snap install typora-alanzanattadev</p>
</blockquote>
<p>使用直接输入命令 <code>typora-alanzanattadev</code></p>
<h2 id="安装常用-build-工具"><a href="#安装常用-build-工具" class="headerlink" title="安装常用 build 工具"></a>安装常用 build 工具</h2><p><code>sudo apt install build-essential gcc-multilib g++-multilib</code></p>
<h2 id="安装和配置-zsh"><a href="#安装和配置-zsh" class="headerlink" title="安装和配置 zsh"></a>安装和配置 zsh</h2><ul>
<li>安装</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git zsh -y</span><br><span class="line"></span><br><span class="line">sh -c &quot;$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>更改默认 shell 为 zsh</li>
</ul>
<p><code>[sudo] chsh -s $(which zsh)</code></p>
<ul>
<li>安装常用插件</li>
<li>autojump</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python</span><br><span class="line"></span><br><span class="line"># ------ linux -----</span><br><span class="line"></span><br><span class="line">proxychains git clone git://github.com/joelthelion/autojump.git</span><br><span class="line"></span><br><span class="line">cd autojump</span><br><span class="line"></span><br><span class="line">./install.py</span><br><span class="line"></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"># 在文件里找到plugins，添加</span><br><span class="line"></span><br><span class="line">plugins=(autojump)</span><br><span class="line"></span><br><span class="line"># 在文件末尾添加</span><br><span class="line"></span><br><span class="line">[[ -s /home/tg/.autojump/etc/profile.d/autojump.sh ]] &amp;&amp; source /home/tg/.autojump/etc/profile.d/autojump.sh</span><br><span class="line"></span><br><span class="line">source ~/.zshrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>zsh-autosuggestions</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">proxychains git clone git://github.com/zsh-users/zsh-autosuggestions $ZSH_CUSTOM/plugins/zsh-autosuggestions</span><br><span class="line"></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"># 在文件里找到plugins，添加</span><br><span class="line"></span><br><span class="line">plugins=(</span><br><span class="line"></span><br><span class="line">  autojump</span><br><span class="line"></span><br><span class="line">  zsh-autosuggestions</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">source ~/.zshrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>zsh-syntax-highlighting</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line"></span><br><span class="line">proxychains git clone git://github.com/zsh-users/zsh-syntax-highlighting $ZSH_CUSTOM/plugins/zsh-syntax-highlighting</span><br><span class="line"></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"># 在文件里找到plugins，添加</span><br><span class="line"></span><br><span class="line">plugins=(</span><br><span class="line"></span><br><span class="line">  autojump</span><br><span class="line"></span><br><span class="line">  zsh-autosuggestions</span><br><span class="line"></span><br><span class="line">  zsh-syntax-highlighting</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">source ~/.zshrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装和使用-tmux"><a href="#安装和使用-tmux" class="headerlink" title="安装和使用 tmux"></a>安装和使用 tmux</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/ryerh/14b7c24dfd623ef8edc7">https://gist.github.com/ryerh/14b7c24dfd623ef8edc7</a></p>
<h2 id="网络监控和-CPU-x2F-内存监控"><a href="#网络监控和-CPU-x2F-内存监控" class="headerlink" title="网络监控和 CPU&#x2F;内存监控"></a>网络监控和 CPU&#x2F;内存监控</h2><p>jnettop&#x2F;htop</p>
<h2 id="安装-pyenv"><a href="#安装-pyenv" class="headerlink" title="安装 pyenv"></a>安装 pyenv</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/cedricbonhomme/ababe00d0a675ea5c69d777276e8f375">https://gist.github.com/cedricbonhomme/ababe00d0a675ea5c69d777276e8f375</a></p>
<h2 id="编译-aosp"><a href="#编译-aosp" class="headerlink" title="编译 aosp"></a>编译 aosp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bison tree</span><br><span class="line"></span><br><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line">sudo apt install libc6:i386 libncurses5:i386 libstdc++6:i386</span><br><span class="line"></span><br><span class="line">sudo apt install libxml2-utils</span><br><span class="line"></span><br><span class="line">sudo apt install openjdk-8-jdk</span><br><span class="line"></span><br><span class="line">sudo apt-get install libncurses5</span><br><span class="line"></span><br><span class="line">sudo apt install htop</span><br><span class="line"></span><br><span class="line">sudo apt-get install bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>For Ubuntu versions older than 20.04 (focal), install also:</p>
<ul>
<li><code>libwxgtk3.0-dev</code></li>
</ul>
<p>While for Ubuntu versions older than 16.04 (xenial), install:</p>
<ul>
<li><code>libwxgtk2.8-dev</code></li>
</ul>
<p>mouxuejie.com&#x2F;blog&#x2F;2019-11-17&#x2F;aosp-setup&#x2F;</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/</a></p>
<p>使用清华源，先下载 repo 工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">proxychains repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-8.1.0_r1</span><br><span class="line"></span><br><span class="line">repo sync</span><br><span class="line"></span><br><span class="line">rm -rf .repo</span><br><span class="line"></span><br><span class="line">// 打个A</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>下载驱动</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://developers.google.com/android/drivers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://developers.google.com/android/drivers#sailfishopm1.171019.011</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解压驱动后生成 ventor 目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"></span><br><span class="line">lunch(选aosp_sailfish-userdebug)</span><br><span class="line"></span><br><span class="line">make -j16</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其他错误处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LC_ALL=C</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下载<code>sailfish-opm1.171019.011-factory-56d15350</code>并解包，然后解压里面的<code>image-sailfish-opm1.171019.011.zip</code>,将原来的 img 文件全部删除，替换成我们刚刚编译好的 aosp 里的 img，其路径在<code>out/target/product/sailfish</code>,然后重新打包成<code>image-sailfish-opm1.171019.011.zip</code>,刷入即可</p>
<p>记得要使用刚刚编译出来的 aosp 里内置的那个 Fastboot,位置在如下这里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/home/tg/gitsource/repo/build/out/host/linux-x86/bin</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">./flash-all.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="清理拖拽文件缓存"><a href="#清理拖拽文件缓存" class="headerlink" title="清理拖拽文件缓存"></a>清理拖拽文件缓存</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.cache/vmware/drag_and_drop/</span><br><span class="line"></span><br><span class="line">du -d 1 -h</span><br><span class="line"></span><br><span class="line">rm -rf *</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="编译-aosp-内核"><a href="#编译-aosp-内核" class="headerlink" title="编译 aosp 内核"></a>编译 aosp 内核</h2><p><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/building-kernels">https://source.android.com/setup/build/building-kernels</a></p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/building-kernels-deprecated">https://source.android.com/setup/build/building-kernels-deprecated</a></p>
<ul>
<li>goldfish 项目包含适用于模拟平台的内核源代码。</li>
<li>msm 项目包含适用于 ADP1、ADP2、Nexus One、Nexus 4、Nexus 5、Nexus 6、Nexus 5X、Nexus 6P、Nexus 7 (2013)、Pixel 和 Pixel XL 的源代码，可用作在 Qualcomm MSM 芯片组上开展相关工作的着手点。</li>
</ul>
<p>找到 aosp 里 kernel 的路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Pixel (sailfish)</span><br><span class="line"></span><br><span class="line">Pixel XL (marlin)	device/google/marlin-kernel	android-msm-marlin-3.18-pie-qpr2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改内核过反调试，以 trace pid 为例</p>
<p>事实上，我们可以在设置 &gt; 关于手机 &gt; 内核版本 中直接查看内核版本信息，也可以通过 cat &#x2F;proc&#x2F;version 命令查看。内核版本信息的格式为 kernel version-gXXXXXXX,其中 XXXXXXX 部分的值是 git 提交中 的 short commit id 的值（即 kernel version-g</p>
<p>），short commit id 的值为 commit id 值的前 7 位。Nexus 5 设备 Adnroid 4.4.4_r1 版本 AOSP 自带的内核值是&#96;3.4.0-gd59db4e , 并且刷入手机能正常运行。</p>
<p>检出带代码有两种方式（推荐第二种)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">git clone https://aosp.tuna.tsinghua.edu.cn/kernel/msm.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git checkout 1292056</span><br><span class="line"></span><br><span class="line">Updating files: 100% (52159/52159), done.</span><br><span class="line"></span><br><span class="line">Note: switching to &#x27;1292056&#x27;.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You are in &#x27;detached HEAD&#x27; state. You can look around, make experimental</span><br><span class="line"></span><br><span class="line">changes and commit them, and you can discard any commits you make in this</span><br><span class="line"></span><br><span class="line">state without impacting any branches by switching back to a branch.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">If you want to create a new branch to retain commits you create, you may</span><br><span class="line"></span><br><span class="line">do so (now or later) by using -c with the switch command. Example:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  git switch -c &lt;new-branch-name&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Or undo this operation with:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  git switch -</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Turn off this advice by setting config variable advice.detachedHead to false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEAD is now at 129205686dee qcacld-2.0: wlan host driver upgrade to 4.4.25.047</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">export ARCH=arm64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> export PATH=/home/tg/gitsource/repo/build/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin:$PATH</span><br><span class="line"></span><br><span class="line">export CROSS_COMPILE=aarch64-linux-android-</span><br><span class="line"></span><br><span class="line">make marlin_defconfig</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>/home/tg/gitsource/repo/build/kernel/msm/arch/arm64/boot/Image.lz4-dtb</code>就是生成出来的 kernel</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"></span><br><span class="line">lunch(选aosp_sailfish-userdebug)</span><br><span class="line"></span><br><span class="line">export TARGET_PREBUILT_KERNEL=/home/tg/gitsource/repo/build/kernel/msm/arch/arm64/boot/Image.lz4-dtb</span><br><span class="line"></span><br><span class="line">make -j16</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后可以看到 out 里的 boot.img 已经更新了，重打包刷机即可。</p>
<p>关于过 trace-pid，需要修改的代码在这里</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lasting-yang/msm/commit/99ad1405ef0f12d94ca605de4db0b989da3a3b25">https://github.com/lasting-yang/msm/commit/99ad1405ef0f12d94ca605de4db0b989da3a3b25</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/10/06/KUbuntu%2020%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" data-id="cl8x7xxbj000ie875gbjpg73f" data-title="KUbuntu20 环境配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%9E%8E%E6%8A%98%E8%85%BE/" rel="tag">瞎折腾</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-LLVM_IR概述与常用指令" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" class="article-date">
  <time class="dt-published" datetime="2022-06-09T02:28:25.000Z" itemprop="datePublished">2022-06-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">LLVM从小白到放弃（三）- LLVM IR概述与常用指令</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="LLVM-IR概述"><a href="#LLVM-IR概述" class="headerlink" title="LLVM IR概述"></a>LLVM IR概述</h3><ul>
<li>优化是对LLVM IR进行操作：</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/1.png"></p>
<h4 id="什么是LLVM-IR"><a href="#什么是LLVM-IR" class="headerlink" title="什么是LLVM IR"></a>什么是LLVM IR</h4><ul>
<li>LLVM IR 是一门低级语言，语法类似于汇编</li>
<li>任何高级编程语言（如C++）都可以用LLVM IR表示</li>
<li>基于LLVM IR可以很方便地进行代码优化</li>
</ul>
<h4 id="LLVM-IR的两种表示方法"><a href="#LLVM-IR的两种表示方法" class="headerlink" title="LLVM IR的两种表示方法"></a>LLVM IR的两种表示方法</h4><ul>
<li>第一种是人类可以阅读的文本形式，文件后缀为.ll</li>
<li>第二种是易于机器处理的二进制格式，文件后缀为.bc</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/2.png"></p>
<h4 id="LLVM-IR结构"><a href="#LLVM-IR结构" class="headerlink" title="LLVM IR结构"></a>LLVM IR结构</h4><ul>
<li>源代码被编译为LLVM IR后，具有以下结构：</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/3.png"></p>
<h5 id="LLVM-IR结构：模块-Module"><a href="#LLVM-IR结构：模块-Module" class="headerlink" title="LLVM IR结构：模块 Module"></a>LLVM IR结构：模块 Module</h5><ul>
<li>一个源代码对应LLVM IR中的一个模块。</li>
<li>头部信息包含程序的目标平台，如X86、ARM等，和一些其他信息。</li>
<li>全局符号包含全局变量、函数的定义与声明。</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/4.png"></p>
<h5 id="LLVM-IR结构：函数-Function"><a href="#LLVM-IR结构：函数-Function" class="headerlink" title="LLVM IR结构：函数 Function"></a>LLVM IR结构：函数 Function</h5><ul>
<li>LLVM IR中的函数表示源代码中的某个函数。</li>
<li>参数，顾名思义为函数的参数。</li>
<li>一个函数由若干基本块组成，其中函数最先执行的基本块为入口块。</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/5.png"></p>
<h5 id="LLVM-IR结构：基本块-BasicBlock"><a href="#LLVM-IR结构：基本块-BasicBlock" class="headerlink" title="LLVM IR结构：基本块 BasicBlock"></a>LLVM IR结构：基本块 BasicBlock</h5><ul>
<li>一个基本块由若干个指令和标签组成。</li>
<li>正常情况下，基本块的最后一条指令为跳转指令（br或者switch），或返回指令（retn），也叫作终结指令（Terminator Instruction）。</li>
<li>PHI指令是一种特殊的指令。</li>
</ul>
<p><img src="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/6.png"></p>
<h5 id="LLVM-IR结构-1"><a href="#LLVM-IR结构-1" class="headerlink" title="LLVM IR结构"></a>LLVM IR结构</h5><ul>
<li>了解LLVM IR的结构是我们学习代码混淆的基础，举个例子<ul>
<li>以函数为基本单位的混淆：控制流平坦化</li>
<li>以基本块为基本单位的混淆：虚假控制流</li>
<li>以指令为基本单位的混淆：指令替代</li>
</ul>
</li>
</ul>
<h3 id="LLVM-IR常用指令讲解"><a href="#LLVM-IR常用指令讲解" class="headerlink" title="LLVM IR常用指令讲解"></a>LLVM IR常用指令讲解</h3><ul>
<li><p>终结指令 Terminator Instructions</p>
<ul>
<li>ret指令<ul>
<li>函数返回指令，对应C&#x2F;C++中的return。</li>
</ul>
</li>
<li>br指令<ul>
<li>br是“分支”的英文branch的缩写，分为非条件分支和条件分支，对应C&#x2F;C++的if语句</li>
<li>无条件分支类似有x86汇编中的jmp指令，条件分支类似于x86汇编中的jnz，je等条件跳转指令。</li>
</ul>
</li>
</ul>
</li>
<li><p>比较指令</p>
<ul>
<li>icmp指令<ul>
<li>整数或指针的比较指令</li>
<li>条件cond可以是eq（相等），ne（不相等），ugt（无符号相等）</li>
</ul>
</li>
<li>fcmp指令<ul>
<li>浮点数的比较指令</li>
<li>条件cond可以是oeq（ordered and equal），ueq（unordered or equal）</li>
</ul>
</li>
<li>switch指令<ul>
<li>分支指令，可看做是br指令的升级版，支持的分支更多，但使用也更复杂，对应C&#x2F;C++中的switch。</li>
</ul>
</li>
</ul>
</li>
<li><p>二元运算 Binary Operations</p>
<ul>
<li>add指令</li>
<li>sub指令</li>
<li>mul指令</li>
<li>udiv指令<ul>
<li>无符号整数除法指令</li>
</ul>
</li>
<li>sdiv指令<ul>
<li>有符号整数除法指令</li>
</ul>
</li>
<li>urem指令<ul>
<li>无符号整数取余指令</li>
</ul>
</li>
<li>srem指令<ul>
<li>有符号整数取余指令</li>
</ul>
</li>
</ul>
</li>
<li><p>按位二元运算 Bitwise Binary Operations</p>
<ul>
<li>shl指令<ul>
<li>整数左移操作指令</li>
</ul>
</li>
<li>lshr指令<ul>
<li>整数右移指令</li>
</ul>
</li>
<li>ashr指令<ul>
<li>整数算数右移指令</li>
</ul>
</li>
<li>and指令<ul>
<li>整数按位与运算指令</li>
</ul>
</li>
<li>or指令<ul>
<li>整数按位或运算指令</li>
</ul>
</li>
<li>xor指令<ul>
<li>整数按位异或运算指令</li>
</ul>
</li>
</ul>
</li>
<li><p>内存访问和寻址操作 Memory Access and Addressing Operations</p>
<ul>
<li>alloca指令<ul>
<li>内存分配指令，在栈中分配一块空间并获得指向该空间的指针，类似与C&#x2F;C++中的malloc函数</li>
</ul>
</li>
<li>store指令<ul>
<li>内存存储指令，向指针指向的内存中存储数据，类似与C&#x2F;C++中的指针引用后的赋值操作</li>
<li></li>
</ul>
</li>
</ul>
</li>
<li><p>类型转换操作 Conversion Operations</p>
<ul>
<li>trunc..to指令<ul>
<li>截断指令，将一种类型的变量截断为另一种类型的变量。</li>
</ul>
</li>
<li>zext..to指令<ul>
<li>零扩展指令，将一种类型的变量拓展为另一种类型的变量，高位补0。</li>
</ul>
</li>
<li>sext..to指令<ul>
<li>符号位拓展指令，通过复制符号位（最高位）将一种类型的变量拓展为另一种类型的变量。</li>
</ul>
</li>
</ul>
</li>
<li><p>其他操作 Other Operations</p>
<ul>
<li><p>phi指令：由静态单赋值引起的问题</p>
</li>
<li><p>select指令</p>
<ul>
<li>? : 三元运算符</li>
</ul>
</li>
<li><p>call指令</p>
<ul>
<li>call指令用来调用某个函数，对应C&#x2F;C++中的函数调用，与x86汇编中的call指令类似。</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" data-id="cl8x7xxbk000ke875bz81dfd3" data-title="LLVM从小白到放弃（三）- LLVM IR概述与常用指令" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLVM/" rel="tag">LLVM</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-LLVM_Pass" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/08/LLVM_Pass/" class="article-date">
  <time class="dt-published" datetime="2022-06-08T02:28:25.000Z" itemprop="datePublished">2022-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/08/LLVM_Pass/">LLVM从小白到放弃（二）- LLVM Pass</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="LLVM-Pass的基本概念"><a href="#LLVM-Pass的基本概念" class="headerlink" title="LLVM Pass的基本概念"></a>LLVM Pass的基本概念</h2><ul>
<li>LLVM Pass框架是整个LLVM 提供给用户用来干预代码优化过程的框架，也是我们编写代码混淆工具的基础。</li>
<li>编译后的LLVM Pass通过优化器opt进行加载，可以对LLVM IR中间代码进行分析和修改，生成新的中间代码。</li>
</ul>
<p><img src="/2022/06/08/LLVM_Pass/1.jpg"></p>
<h4 id="llvm-x2F-inlcude-x2F-llvm-文件夹"><a href="#llvm-x2F-inlcude-x2F-llvm-文件夹" class="headerlink" title="llvm&#x2F;inlcude&#x2F;llvm 文件夹"></a>llvm&#x2F;inlcude&#x2F;llvm 文件夹</h4><ul>
<li>llvm&#x2F;include&#x2F;llvm 文件夹存放了LLVM提供的一些公共头文件。</li>
<li>即我们在开发过程中可以使用的头文件。</li>
</ul>
<p><img src="/2022/06/08/LLVM_Pass/1.png"></p>
<h4 id="llvm-x2F-lib文件夹"><a href="#llvm-x2F-lib文件夹" class="headerlink" title="llvm&#x2F;lib文件夹"></a>llvm&#x2F;lib文件夹</h4><ul>
<li>llvm&#x2F;lib文件夹存放了LLVM大部分源代码（.cpp文件）和一些不公开的头文件</li>
</ul>
<p><img src="/2022/06/08/LLVM_Pass/2.png"></p>
<h4 id="llvm-x2F-lib-x2F-Transforms"><a href="#llvm-x2F-lib-x2F-Transforms" class="headerlink" title="llvm&#x2F;lib&#x2F;Transforms"></a>llvm&#x2F;lib&#x2F;Transforms</h4><ul>
<li>llvm&#x2F;lib&#x2F;Transforms文件夹存放<strong>所有LLVM Pass的源代码</strong></li>
<li>llvm&#x2F;lib&#x2F;Transforms文件夹也存放了一些LLVM自带的Pass</li>
</ul>
<h4 id="LLVM-Pass的编写、编译以及加载"><a href="#LLVM-Pass的编写、编译以及加载" class="headerlink" title="LLVM Pass的编写、编译以及加载"></a>LLVM Pass的编写、编译以及加载</h4><h5 id="LLVM-Pass的编写：Hello-World"><a href="#LLVM-Pass的编写：Hello-World" class="headerlink" title="LLVM Pass的编写：Hello World"></a>LLVM Pass的编写：Hello World</h5><ul>
<li>LLVM Pass支持三种编译方式：<ul>
<li>第一种是与整个LLVM一起重新编译，Pass代码需要存放在llvm&#x2F;lib&#x2F;Transforms文件夹中 （编译太耗时间）</li>
<li>第二种方法是通过CMake对Pass进行单独编译 （好！）</li>
<li>第三种方法是使用命令行对Pass进行单独编译 （项目越大越不好管理）</li>
</ul>
</li>
<li>在设计一个新的LLVM Pass时，你最先要决定的就是选择Pass的类型。</li>
<li>LLVM有多种类型的Pass可供选择，包括：ModulePass、<strong>FuncitonPass</strong>、CallGraphPass、LoopPass等等。</li>
<li>FunctionPass以函数为单位进行处理</li>
<li>FunctionPass的子类必须实现runOnFunction（Function &amp;F）函数。</li>
<li>在FunctionPass运行时，会对程序中的每个函数执行runOnFunction函数。</li>
</ul>
<h5 id="LLVM-Pass的编写：步骤"><a href="#LLVM-Pass的编写：步骤" class="headerlink" title="LLVM Pass的编写：步骤"></a>LLVM Pass的编写：步骤</h5><ul>
<li>创建一个类（class），继承FunctionPass父类</li>
<li>在创建的类中实现runOnFunction(Function &amp;F)函数</li>
<li>向 LLVM 注册我们的 Pass 类。</li>
</ul>
<h5 id="LLVM-Pass的加载"><a href="#LLVM-Pass的加载" class="headerlink" title="LLVM Pass的加载"></a>LLVM Pass的加载</h5><ul>
<li>使用优化器 opt 将处理中间代码，生成新的中间代码：</li>
</ul>
<blockquote>
<p>opt -load .&#x2F;LLVMObfuscator.so -hlw -S hello.ll -o hello_opt.ll </p>
</blockquote>
<ul>
<li>-load 加载编译好的 LLVM Pass（.so文件）进行优化</li>
</ul>
<h3 id="编写第一个LLVM-Pass-实践部分"><a href="#编写第一个LLVM-Pass-实践部分" class="headerlink" title="编写第一个LLVM Pass-实践部分"></a>编写第一个LLVM Pass-实践部分</h3><h4 id="CMake创建"><a href="#CMake创建" class="headerlink" title="CMake创建"></a>CMake创建</h4><p>目录结构：</p>
<blockquote>
<p>➜  OLLVM++-DEmo tree</p>
</blockquote>
<blockquote>
<p>.</p>
</blockquote>
<blockquote>
<p>├── Build</p>
</blockquote>
<blockquote>
<p>├── Test</p>
</blockquote>
<blockquote>
<p>│   └── TestProgram.cpp</p>
</blockquote>
<blockquote>
<p>├── test.sh</p>
</blockquote>
<blockquote>
<p>└── Transforms</p>
</blockquote>
<blockquote>
<p>​    ├── CMakeLists.txt</p>
</blockquote>
<blockquote>
<p>​    ├── include</p>
</blockquote>
<blockquote>
<p>​    └── src</p>
</blockquote>
<blockquote>
<p>​        └── HelloWorld.cpp</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>5 directories, 4 files</p>
</blockquote>
<p><img src="/2022/06/08/LLVM_Pass/3.png"></p>
<h4 id="LLVM-Pass的编写、编译以及加载-1"><a href="#LLVM-Pass的编写、编译以及加载-1" class="headerlink" title="LLVM Pass的编写、编译以及加载"></a>LLVM Pass的编写、编译以及加载</h4><h5 id="各自目录功能介绍"><a href="#各自目录功能介绍" class="headerlink" title="各自目录功能介绍"></a>各自目录功能介绍</h5><p>Build 文件夹：存放编译后 LLVM Pass </p>
<p>Test 文件夹：存放测试程序 TestProgram.cpp </p>
<p>Test&#x2F;TestProgram.cpp：一个简单的 CTF 逆向题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// Test/TestProgram.cpp</span><br><span class="line"></span><br><span class="line">#include &lt;cstdio&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;cstring&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">char input[100] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">char enc[100] = &quot;\x86\x8a\x7d\x87\x93\x8b\x4d\x81\x80\x8a\x43\x7f\x49\x49\x86\x71\x7f\x62\x53\x69\x28\x9d&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void encrypt(unsigned char *dest, char *src) &#123;</span><br><span class="line"></span><br><span class="line">    int len = strlen(src);</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; len; i ++) &#123;</span><br><span class="line"></span><br><span class="line">        dest[i] = (src[i] + (32 - i)) ^ i;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line"></span><br><span class="line">    printf(&quot;Please input your flag: &quot;);</span><br><span class="line"></span><br><span class="line">    scanf(&quot;%s&quot;, input);</span><br><span class="line"></span><br><span class="line">    unsigned char dest[100] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">    encrypt(dest, input);</span><br><span class="line"></span><br><span class="line">    bool result = strlen(input) == 22 &amp;&amp; !memcmp(dest, enc, 22);</span><br><span class="line"></span><br><span class="line">    if (result) &#123;</span><br><span class="line"></span><br><span class="line">        printf(&quot;Congratulations~\n&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        printf(&quot;Sorry try again.\n&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Transforms&#x2F;include 文件夹：存放整个 LLVM Pass 项目的头文件，暂时还没有用到 </p>
<p>Transforms&#x2F;src 文件夹：存放整个 LLVM Pass 项目的源代码 </p>
<p>Transforms&#x2F;src&#x2F;HelloWorld.cpp：HelloWorld Pass 的源代码，一般来说一个 Pass 使用一个 cpp 文件 实现即可。 </p>
<p>Transforms&#x2F;CMakeLists.txt：整个 CMake 项目的配置文件，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 参考官方文档：https://llvm.org/docs/CMake.html#developing-llvm-passes-out-of-source </span><br><span class="line"></span><br><span class="line">project(OLLVM++) </span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION 3.13.4) </span><br><span class="line"></span><br><span class="line">find_package(LLVM REQUIRED CONFIG) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH &quot;$&#123;LLVM_CMAKE_DIR&#125;&quot;)</span><br><span class="line"></span><br><span class="line">include(AddLLVM) </span><br><span class="line"></span><br><span class="line">include_directories(&quot;./include&quot;) # 包含 ./include 文件夹中的头文件 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">separate_arguments(LLVM_DEFINITIONS_LIST NATIVE_COMMAND $&#123;LLVM_DEFINITIONS&#125;) </span><br><span class="line"></span><br><span class="line">add_definitions($&#123;LLVM_DEFINITIONS_LIST&#125;) </span><br><span class="line"></span><br><span class="line">include_directories($&#123;LLVM_INCLUDE_DIRS&#125;) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_llvm_library( </span><br><span class="line"></span><br><span class="line">    LLVMObfuscator MODULE </span><br><span class="line"></span><br><span class="line">    src/HelloWorld.cpp </span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>test.sh：编译 LLVM Pass 并对 Test 文件夹中的代码进行测试，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./Build</span><br><span class="line"></span><br><span class="line">cmake ../Transforms</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../Test</span><br><span class="line"></span><br><span class="line">clang -S -emit-llvm TestProgram.cpp -o TestProgram.ll</span><br><span class="line"></span><br><span class="line">opt -load ../Build/LLVMObfuscator.so -hlw -S TestProgram.ll -o TestProgram_hlw.ll</span><br><span class="line"></span><br><span class="line">clang TestProgram_hlw.ll -o TestProgram_hlw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./TestProgram_hlw</span><br></pre></td></tr></table></figure>

<h5 id="LLVM-Pass源代码模板"><a href="#LLVM-Pass源代码模板" class="headerlink" title="LLVM  Pass源代码模板"></a>LLVM  Pass源代码模板</h5><ul>
<li>创建一个类（class），继承FunctionPass父类</li>
<li>在创建的类中实现runOnFunction(Function &amp;F)函数</li>
<li>向LLVM注册我们的Pass类</li>
</ul>
<p>HelloWorld.cpp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;llvm/Pass.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;llvm/IR/Function.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;llvm/Support/raw_ostream.h&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">using namespace llvm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace&#123;</span><br><span class="line"></span><br><span class="line">    class HelloWorld : public FunctionPass &#123; // 继承Pass的FunctionPass </span><br><span class="line"></span><br><span class="line">        public:</span><br><span class="line"></span><br><span class="line">            static char ID;</span><br><span class="line"></span><br><span class="line">            HelloWorld() : FunctionPass(ID) &#123;</span><br><span class="line"></span><br><span class="line">                // 构造函数</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            bool runOnFunction(Function &amp;F); // runOnFunction实现</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bool HelloWorld::runOnFunction(Function &amp;F) &#123;</span><br><span class="line"></span><br><span class="line">    // todo</span><br><span class="line"></span><br><span class="line">    outs() &lt;&lt; &quot;Hello, &quot; &lt;&lt; F.getName() &lt;&lt; &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">char HelloWorld::ID = 0;</span><br><span class="line"></span><br><span class="line">static RegisterPass&lt;HelloWorld&gt; X(&quot;hlw&quot;, &quot;Pass 描述.&quot;);</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/2022/06/08/LLVM_Pass/4.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/06/08/LLVM_Pass/" data-id="cl8x7xxbk000me875hivl402l" data-title="LLVM从小白到放弃（二）- LLVM Pass" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLVM/" rel="tag">LLVM</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Android加载SO整个流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/22/Android%E5%8A%A0%E8%BD%BDSO%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2022-04-22T02:28:25.000Z" itemprop="datePublished">2022-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/22/Android%E5%8A%A0%E8%BD%BDSO%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B/">Android加载SO整个流程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="/2022/04/22/Android%E5%8A%A0%E8%BD%BDSO%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B/1.jpg"></p>
<p>java_vm_ext.cc -&gt; <strong>JavaVMExt</strong>::<strong>LoadNativeLibrary</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">JavaVMExt::LoadNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> std::string&amp; path,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  jstring library_path,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  std::string* error_msg)</span> </span>&#123;</span><br><span class="line">  error_msg-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// See if we&#x27;ve already loaded this library.  If we have, and the class loader</span></span><br><span class="line">  <span class="comment">// matches, return successfully without doing anything.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> for better results we should canonicalize the pathname (or even compare</span></span><br><span class="line">  <span class="comment">// inodes). This implementation is fine if everybody is using System.loadLibrary.</span></span><br><span class="line">  SharedLibrary* library;</span><br><span class="line">  Thread* self = Thread::<span class="built_in">Current</span>();</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> move the locking (and more of this logic) into Libraries.</span></span><br><span class="line">    <span class="function">MutexLock <span class="title">mu</span><span class="params">(self, *Locks::jni_libraries_lock_)</span></span>;</span><br><span class="line">    library = libraries_-&gt;<span class="built_in">Get</span>(path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">void</span>* class_loader_allocator = <span class="literal">nullptr</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">ScopedObjectAccess <span class="title">soa</span><span class="params">(env)</span></span>;</span><br><span class="line">    <span class="comment">// As the incoming class loader is reachable/alive during the call of this function,</span></span><br><span class="line">    <span class="comment">// it&#x27;s okay to decode it without worrying about unexpectedly marking it alive.</span></span><br><span class="line">    ObjPtr&lt;mirror::ClassLoader&gt; loader = soa.<span class="built_in">Decode</span>&lt;mirror::ClassLoader&gt;(class_loader);</span><br><span class="line"></span><br><span class="line">    ClassLinker* class_linker = Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetClassLinker</span>();</span><br><span class="line">    <span class="keyword">if</span> (class_linker-&gt;<span class="built_in">IsBootClassLoader</span>(soa, loader.<span class="built_in">Ptr</span>())) &#123;</span><br><span class="line">      loader = <span class="literal">nullptr</span>;</span><br><span class="line">      class_loader = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class_loader_allocator = class_linker-&gt;<span class="built_in">GetAllocatorForClassLoader</span>(loader.<span class="built_in">Ptr</span>());</span><br><span class="line">    <span class="built_in">CHECK</span>(class_loader_allocator != <span class="literal">nullptr</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (library != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="comment">// Use the allocator pointers for class loader equality to avoid unnecessary weak root decode.</span></span><br><span class="line">    <span class="keyword">if</span> (library-&gt;<span class="built_in">GetClassLoaderAllocator</span>() != class_loader_allocator) &#123;</span><br><span class="line">      <span class="comment">// The library will be associated with class_loader. The JNI</span></span><br><span class="line">      <span class="comment">// spec says we can&#x27;t load the same library into more than one</span></span><br><span class="line">      <span class="comment">// class loader.</span></span><br><span class="line">      <span class="built_in">StringAppendF</span>(error_msg, <span class="string">&quot;Shared library \&quot;%s\&quot; already opened by &quot;</span></span><br><span class="line">          <span class="string">&quot;ClassLoader %p; can&#x27;t open in ClassLoader %p&quot;</span>,</span><br><span class="line">          path.<span class="built_in">c_str</span>(), library-&gt;<span class="built_in">GetClassLoader</span>(), class_loader);</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; error_msg;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Shared library \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot; already loaded in &quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot; ClassLoader &quot;</span> &lt;&lt; class_loader &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!library-&gt;<span class="built_in">CheckOnLoadResult</span>()) &#123;</span><br><span class="line">      <span class="built_in">StringAppendF</span>(error_msg, <span class="string">&quot;JNI_OnLoad failed on a previous attempt &quot;</span></span><br><span class="line">          <span class="string">&quot;to load \&quot;%s\&quot;&quot;</span>, path.<span class="built_in">c_str</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Open the shared library.  Because we&#x27;re using a full path, the system</span></span><br><span class="line">  <span class="comment">// doesn&#x27;t have to search through LD_LIBRARY_PATH.  (It may do so to</span></span><br><span class="line">  <span class="comment">// resolve this library&#x27;s dependencies though.)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Failures here are expected when java.library.path has several entries</span></span><br><span class="line">  <span class="comment">// and we have to hunt for the lib.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></span><br><span class="line">  <span class="comment">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></span><br><span class="line">  <span class="comment">// dlopen) becomes zero from dlclose.</span></span><br><span class="line"></span><br><span class="line">  Locks::mutator_lock_-&gt;<span class="built_in">AssertNotHeld</span>(self);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* path_str = path.<span class="built_in">empty</span>() ? <span class="literal">nullptr</span> : path.<span class="built_in">c_str</span>();</span><br><span class="line">  <span class="type">bool</span> needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">void</span>* handle = android::<span class="built_in">OpenNativeLibrary</span>(env,</span><br><span class="line">                                            runtime_-&gt;<span class="built_in">GetTargetSdkVersion</span>(),</span><br><span class="line">                                            path_str,</span><br><span class="line">                                            class_loader,</span><br><span class="line">                                            library_path,</span><br><span class="line">                                            &amp;needs_native_bridge,</span><br><span class="line">                                            error_msg);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Call to dlopen(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;, RTLD_NOW) returned &quot;</span> &lt;&lt; handle &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;dlopen(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;, RTLD_NOW) failed: &quot;</span> &lt;&lt; *error_msg;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>() == JNI_TRUE) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Unexpected exception:&quot;</span>;</span><br><span class="line">    env-&gt;<span class="built_in">ExceptionDescribe</span>();</span><br><span class="line">    env-&gt;<span class="built_in">ExceptionClear</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Create a new entry.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> move the locking (and more of this logic) into Libraries.</span></span><br><span class="line">  <span class="type">bool</span> created_library = <span class="literal">false</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;SharedLibrary&gt; <span class="title">new_library</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> SharedLibrary(env,</span></span></span><br><span class="line"><span class="params"><span class="function">                          self,</span></span></span><br><span class="line"><span class="params"><span class="function">                          path,</span></span></span><br><span class="line"><span class="params"><span class="function">                          handle,</span></span></span><br><span class="line"><span class="params"><span class="function">                          needs_native_bridge,</span></span></span><br><span class="line"><span class="params"><span class="function">                          class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                          class_loader_allocator))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MutexLock <span class="title">mu</span><span class="params">(self, *Locks::jni_libraries_lock_)</span></span>;</span><br><span class="line">    library = libraries_-&gt;<span class="built_in">Get</span>(path);</span><br><span class="line">    <span class="keyword">if</span> (library == <span class="literal">nullptr</span>) &#123;  <span class="comment">// We won race to get libraries_lock.</span></span><br><span class="line">      library = new_library.<span class="built_in">release</span>();</span><br><span class="line">      libraries_-&gt;<span class="built_in">Put</span>(path, library);</span><br><span class="line">      created_library = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!created_library) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;WOW: we lost a race to add shared library: &quot;</span></span><br><span class="line">        &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot; ClassLoader=&quot;</span> &lt;&lt; class_loader;</span><br><span class="line">    <span class="keyword">return</span> library-&gt;<span class="built_in">CheckOnLoadResult</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Added shared library \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot; for ClassLoader &quot;</span> &lt;&lt; class_loader &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_successful = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">void</span>* sym = library-&gt;<span class="built_in">FindSymbol</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (sym == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[No JNI_OnLoad found in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    was_successful = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Call JNI_OnLoad.  We have to override the current class</span></span><br><span class="line">    <span class="comment">// loader, which will always be &quot;null&quot; since the stuff at the</span></span><br><span class="line">    <span class="comment">// top of the stack is around Runtime.loadLibrary().  (See</span></span><br><span class="line">    <span class="comment">// the comments in the JNI FindClass function.)</span></span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; <span class="built_in">old_class_loader</span>(env, env-&gt;<span class="built_in">NewLocalRef</span>(self-&gt;<span class="built_in">GetClassLoaderOverride</span>()));</span><br><span class="line">    self-&gt;<span class="built_in">SetClassLoaderOverride</span>(class_loader);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Calling JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*JNI_OnLoadFn)</span><span class="params">(JavaVM*, <span class="type">void</span>*)</span></span>;</span><br><span class="line">    JNI_OnLoadFn jni_on_load = <span class="built_in">reinterpret_cast</span>&lt;JNI_OnLoadFn&gt;(sym);</span><br><span class="line">    <span class="type">int</span> version = (*jni_on_load)(<span class="keyword">this</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (runtime_-&gt;<span class="built_in">GetTargetSdkVersion</span>() != <span class="number">0</span> &amp;&amp; runtime_-&gt;<span class="built_in">GetTargetSdkVersion</span>() &lt;= <span class="number">21</span>) &#123;</span><br><span class="line">      <span class="comment">// Make sure that sigchain owns SIGSEGV.</span></span><br><span class="line">      <span class="built_in">EnsureFrontOfChain</span>(SIGSEGV);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self-&gt;<span class="built_in">SetClassLoaderOverride</span>(old_class_loader.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (version == JNI_ERR) &#123;</span><br><span class="line">      <span class="built_in">StringAppendF</span>(error_msg, <span class="string">&quot;JNI_ERR returned from JNI_OnLoad in \&quot;%s\&quot;&quot;</span>, path.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JavaVMExt::<span class="built_in">IsBadJniVersion</span>(version)) &#123;</span><br><span class="line">      <span class="built_in">StringAppendF</span>(error_msg, <span class="string">&quot;Bad JNI version returned from JNI_OnLoad in \&quot;%s\&quot;: %d&quot;</span>,</span><br><span class="line">                    path.<span class="built_in">c_str</span>(), version);</span><br><span class="line">      <span class="comment">// It&#x27;s unwise to call dlclose() here, but we can mark it</span></span><br><span class="line">      <span class="comment">// as bad and ensure that future load attempts will fail.</span></span><br><span class="line">      <span class="comment">// We don&#x27;t know how far JNI_OnLoad got, so there could</span></span><br><span class="line">      <span class="comment">// be some partially-initialized stuff accessible through</span></span><br><span class="line">      <span class="comment">// newly-registered native method calls.  We could try to</span></span><br><span class="line">      <span class="comment">// unregister them, but that doesn&#x27;t seem worthwhile.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      was_successful = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Returned &quot;</span> &lt;&lt; (was_successful ? <span class="string">&quot;successfully&quot;</span> : <span class="string">&quot;failure&quot;</span>)</span><br><span class="line">              &lt;&lt; <span class="string">&quot; from JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  library-&gt;<span class="built_in">SetResult</span>(was_successful);</span><br><span class="line">  <span class="keyword">return</span> was_successful;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>native_loader.cpp -&gt; <strong>android::OpenNativeLibrary</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">OpenNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int32_t</span> target_sdk_version,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">char</span>* path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jstring library_path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">bool</span>* needs_native_bridge,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::string* error_msg)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ANDROID__)</span></span><br><span class="line">  <span class="built_in">UNUSED</span>(target_sdk_version);</span><br><span class="line">  <span class="keyword">if</span> (class_loader == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dlopen</span>(path, RTLD_NOW);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(g_namespaces_mutex)</span></span>;</span><br><span class="line">  NativeLoaderNamespace ns;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!g_namespaces-&gt;<span class="built_in">FindNamespaceByClassLoader</span>(env, class_loader, &amp;ns)) &#123;</span><br><span class="line">    <span class="comment">// This is the case where the classloader was not created by ApplicationLoaders</span></span><br><span class="line">    <span class="comment">// In this case we create an isolated not-shared namespace for it.</span></span><br><span class="line">    <span class="keyword">if</span> (!g_namespaces-&gt;<span class="built_in">Create</span>(env,</span><br><span class="line">                              target_sdk_version,</span><br><span class="line">                              class_loader,</span><br><span class="line">                              <span class="literal">false</span> <span class="comment">/* is_shared */</span>,</span><br><span class="line">                              <span class="literal">false</span> <span class="comment">/* is_for_vendor */</span>,</span><br><span class="line">                              library_path,</span><br><span class="line">                              <span class="literal">nullptr</span>,</span><br><span class="line">                              &amp;ns,</span><br><span class="line">                              error_msg)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ns.<span class="built_in">is_android_namespace</span>()) &#123;</span><br><span class="line">    android_dlextinfo extinfo;</span><br><span class="line">    extinfo.flags = ANDROID_DLEXT_USE_NAMESPACE;</span><br><span class="line">    extinfo.library_namespace = ns.<span class="built_in">get_android_ns</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;extinfo);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error_msg = <span class="built_in">dlerror</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">NativeBridgeLoadLibraryExt</span>(path, RTLD_NOW, ns.<span class="built_in">get_native_bridge_ns</span>());</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error_msg = <span class="built_in">NativeBridgeGetError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="built_in">UNUSED</span>(env, target_sdk_version, class_loader, library_path);</span><br><span class="line">  *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">void</span>* handle = <span class="built_in">dlopen</span>(path, RTLD_NOW);</span><br><span class="line">  <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NativeBridgeIsSupported</span>(path)) &#123;</span><br><span class="line">      *needs_native_bridge = <span class="literal">true</span>;</span><br><span class="line">      handle = <span class="built_in">NativeBridgeLoadLibrary</span>(path, RTLD_NOW);</span><br><span class="line">      <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        *error_msg = <span class="built_in">NativeBridgeGetError</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">      *error_msg = <span class="built_in">dlerror</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> handle;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-8.1.0_r81/xref/bionic/libdl/libdl.c">http://aospxref.com/android-8.1.0_r81/xref/bionic/libdl/libdl.c</a></p>
<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker.cpp?fi=do_dlopen#do_dlopen">http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker.cpp?fi=do_dlopen#do_dlopen</a></p>
<p>do_dlopen，dlopen真正的代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">do_dlopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> <span class="type">void</span>* caller_addr)</span> </span>&#123;</span><br><span class="line">  std::string trace_prefix = std::<span class="built_in">string</span>(<span class="string">&quot;dlopen: &quot;</span>) + (name == <span class="literal">nullptr</span> ? <span class="string">&quot;(nullptr)&quot;</span> : name);</span><br><span class="line">  <span class="function">ScopedTrace <span class="title">trace</span><span class="params">(trace_prefix.c_str())</span></span>;</span><br><span class="line">  <span class="function">ScopedTrace <span class="title">loading_trace</span><span class="params">((trace_prefix + <span class="string">&quot; - loading and linking&quot;</span>).c_str())</span></span>;</span><br><span class="line">  soinfo* <span class="type">const</span> caller = <span class="built_in">find_containing_library</span>(caller_addr);</span><br><span class="line">  <span class="type">android_namespace_t</span>* ns = <span class="built_in">get_caller_namespace</span>(caller);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LD_LOG</span>(kLogDlopen,    </span><br><span class="line">         <span class="string">&quot;dlopen(name=\&quot;%s\&quot;, flags=0x%x, extinfo=%s, caller=\&quot;%s\&quot;, caller_ns=%s@%p) ...&quot;</span>,<span class="number">9</span></span><br><span class="line">         name,</span><br><span class="line">         flags,</span><br><span class="line">         <span class="built_in">android_dlextinfo_to_string</span>(extinfo).<span class="built_in">c_str</span>(),</span><br><span class="line">         caller == <span class="literal">nullptr</span> ? <span class="string">&quot;(null)&quot;</span> : caller-&gt;<span class="built_in">get_realpath</span>(),</span><br><span class="line">         ns == <span class="literal">nullptr</span> ? <span class="string">&quot;(null)&quot;</span> : ns-&gt;<span class="built_in">get_name</span>(),</span><br><span class="line">         ns);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> failure_guard = android::base::<span class="built_in">make_scope_guard</span>(</span><br><span class="line">      [&amp;]() &#123; <span class="built_in">LD_LOG</span>(kLogDlopen, <span class="string">&quot;... dlopen failed: %s&quot;</span>, <span class="built_in">linker_get_error_buffer</span>()); &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; ~(RTLD_NOW|RTLD_LAZY|RTLD_LOCAL|RTLD_GLOBAL|RTLD_NODELETE|RTLD_NOLOAD)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid flags to dlopen: %x&quot;</span>, flags);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extinfo != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ~(ANDROID_DLEXT_VALID_FLAG_BITS)) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid extended flags to android_dlopen_ext: 0x%&quot;</span> PRIx64, extinfo-&gt;flags);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without &quot;</span></span><br><span class="line">          <span class="string">&quot;ANDROID_DLEXT_USE_LIBRARY_FD): 0x%&quot;</span> PRIx64, extinfo-&gt;flags);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_LOAD_AT_FIXED_ADDRESS) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (extinfo-&gt;flags &amp; (ANDROID_DLEXT_RESERVED_ADDRESS | ANDROID_DLEXT_RESERVED_ADDRESS_HINT)) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid extended flag combination: ANDROID_DLEXT_LOAD_AT_FIXED_ADDRESS is not &quot;</span></span><br><span class="line">             <span class="string">&quot;compatible with ANDROID_DLEXT_RESERVED_ADDRESS/ANDROID_DLEXT_RESERVED_ADDRESS_HINT&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (extinfo-&gt;library_namespace == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;ANDROID_DLEXT_USE_NAMESPACE is set but extinfo-&gt;library_namespace is null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ns = extinfo-&gt;library_namespace;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string asan_name_holder;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* translated_name = name;</span><br><span class="line">  <span class="keyword">if</span> (g_is_asan &amp;&amp; translated_name != <span class="literal">nullptr</span> &amp;&amp; translated_name[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    <span class="type">char</span> original_path[PATH_MAX];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">realpath</span>(name, original_path) != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      asan_name_holder = std::<span class="built_in">string</span>(kAsanLibDirPrefix) + original_path;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">file_exists</span>(asan_name_holder.<span class="built_in">c_str</span>())) &#123;</span><br><span class="line">        soinfo* si = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">find_loaded_library_by_realpath</span>(ns, original_path, <span class="literal">true</span>, &amp;si)) &#123;</span><br><span class="line">          <span class="built_in">PRINT</span>(<span class="string">&quot;linker_asan dlopen NOT translating \&quot;%s\&quot; -&gt; \&quot;%s\&quot;: library already loaded&quot;</span>, name,</span><br><span class="line">                asan_name_holder.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">PRINT</span>(<span class="string">&quot;linker_asan dlopen translating \&quot;%s\&quot; -&gt; \&quot;%s\&quot;&quot;</span>, name, translated_name);</span><br><span class="line">          translated_name = asan_name_holder.<span class="built_in">c_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ProtectedDataGuard guard;</span><br><span class="line">  soinfo* si = <span class="built_in">find_library</span>(ns, translated_name, flags, extinfo, caller);</span><br><span class="line">  loading_trace.<span class="built_in">End</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (si != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="type">void</span>* handle = si-&gt;<span class="built_in">to_handle</span>();</span><br><span class="line">    <span class="built_in">LD_LOG</span>(kLogDlopen,</span><br><span class="line">           <span class="string">&quot;... dlopen calling constructors: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,</span><br><span class="line">           si-&gt;<span class="built_in">get_realpath</span>(), si-&gt;<span class="built_in">get_soname</span>(), handle);</span><br><span class="line">    si-&gt;<span class="built_in">call_constructors</span>(); <span class="comment">// 最后dloepn的地方</span></span><br><span class="line">    failure_guard.<span class="built_in">Disable</span>();</span><br><span class="line">    <span class="built_in">LD_LOG</span>(kLogDlopen,</span><br><span class="line">           <span class="string">&quot;... dlopen successful: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,</span><br><span class="line">           si-&gt;<span class="built_in">get_realpath</span>(), si-&gt;<span class="built_in">get_soname</span>(), handle);</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp">http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp</a></p>
<p><strong>call_constructors</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">soinfo::call_constructors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (constructors_called) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We set constructors_called before actually calling the constructors, otherwise it doesn&#x27;t</span></span><br><span class="line">  <span class="comment">// protect against recursive constructor calls. One simple example of constructor recursion</span></span><br><span class="line">  <span class="comment">// is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so:</span></span><br><span class="line">  <span class="comment">// 1. The program depends on libc, so libc&#x27;s constructor is called here.</span></span><br><span class="line">  <span class="comment">// 2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so.</span></span><br><span class="line">  <span class="comment">// 3. dlopen() calls the constructors on the newly created</span></span><br><span class="line">  <span class="comment">//    soinfo for libc_malloc_debug_leak.so.</span></span><br><span class="line">  <span class="comment">// 4. The debug .so depends on libc, so CallConstructors is</span></span><br><span class="line">  <span class="comment">//    called again with the libc soinfo. If it doesn&#x27;t trigger the early-</span></span><br><span class="line">  <span class="comment">//    out above, the libc constructor will be called again (recursively!).</span></span><br><span class="line">  constructors_called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_main_executable</span>() &amp;&amp; preinit_array_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="comment">// The GNU dynamic linker silently ignores these, but we warn the developer.</span></span><br><span class="line">    <span class="built_in">PRINT</span>(<span class="string">&quot;\&quot;%s\&quot;: ignoring DT_PREINIT_ARRAY in shared library!&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">get_children</span>().for_each([] (soinfo* si) &#123;</span><br><span class="line">    si-&gt;<span class="built_in">call_constructors</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_linker</span>()) &#123;</span><br><span class="line">    <span class="built_in">bionic_trace_begin</span>((std::<span class="built_in">string</span>(<span class="string">&quot;calling constructors: &quot;</span>) + <span class="built_in">get_realpath</span>()).<span class="built_in">c_str</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DT_INIT should be called before DT_INIT_ARRAY if both are present.</span></span><br><span class="line">  <span class="built_in">call_function</span>(<span class="string">&quot;DT_INIT&quot;</span>, init_func_, <span class="built_in">get_realpath</span>()); <span class="comment">// .init_proc</span></span><br><span class="line">  <span class="built_in">call_array</span>(<span class="string">&quot;DT_INIT_ARRAY&quot;</span>, init_array_, init_array_count_, <span class="literal">false</span>, <span class="built_in">get_realpath</span>()); <span class="comment">// init_array</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_linker</span>()) &#123;</span><br><span class="line">    <span class="built_in">bionic_trace_end</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp">http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp</a></p>
<p><strong>call_function</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">call_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* function_name __unused,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">linker_dtor_function_t</span> function,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">const</span> <span class="type">char</span>* realpath __unused)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (function == <span class="literal">nullptr</span> || <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(function) == <span class="built_in">static_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(<span class="number">-1</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ Calling d-tor %s @ %p for &#x27;%s&#x27; ]&quot;</span>, function_name, function, realpath);</span><br><span class="line">  <span class="built_in">function</span>();</span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ Done calling d-tor %s @ %p for &#x27;%s&#x27; ]&quot;</span>, function_name, function, realpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp">http://aospxref.com/android-8.1.0_r81/xref/bionic/linker/linker_soinfo.cpp</a></p>
<p><strong>call_array</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">call_array</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* array_name __unused,</span></span></span><br><span class="line"><span class="params"><span class="function">                       F* functions,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">size_t</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">bool</span> reverse,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> <span class="type">char</span>* realpath)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (functions == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ Calling %s (size %zd) @ %p for &#x27;%s&#x27; ]&quot;</span>, array_name, count, functions, realpath);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> begin = reverse ? (count - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> end = reverse ? <span class="number">-1</span> : count;</span><br><span class="line">  <span class="type">int</span> step = reverse ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = begin; i != end; i += step) &#123;</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;[ %s[%d] == %p ]&quot;</span>, array_name, i, functions[i]);</span><br><span class="line">    <span class="built_in">call_function</span>(<span class="string">&quot;function&quot;</span>, functions[i], realpath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ Done calling %s for &#x27;%s&#x27; ]&quot;</span>, array_name, realpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>elf理解的paper：<a target="_blank" rel="noopener" href="https://paper.seebug.org/papers/Archive/refs/elf/Understanding_ELF.pdf">https://paper.seebug.org/papers/Archive/refs/elf/Understanding_ELF.pdf</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/04/22/Android%E5%8A%A0%E8%BD%BDSO%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B/" data-id="cl8x7xxb30000e8754tw84i7d" data-title="Android加载SO整个流程" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-LLVM概述与LLVM环境搭建" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="article-date">
  <time class="dt-published" datetime="2022-04-14T02:28:25.000Z" itemprop="datePublished">2022-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">LLVM从小白到放弃（一）- LLVM概述与LLVM环境搭建</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="LLVM的历史"><a href="#LLVM的历史" class="headerlink" title="LLVM的历史"></a>LLVM的历史</h4><ul>
<li>LLVM计划启动于2000年，开始由美国UIUC大学的Chris Lattner博士主持开展，后来Apple也加入其中。最初的目的是开发一套提供中间代码和编译基础设施的虚拟系统。</li>
<li>LLVM命名最早源自于底层虚拟机（Low Level Virtual Machine）的缩写，随着LLVM项目的不断发展，原先的全称已不再适用，目前LLVM就是该项目的全称。</li>
</ul>
<h4 id="什么是LLVM"><a href="#什么是LLVM" class="headerlink" title="什么是LLVM"></a>什么是LLVM</h4><ul>
<li>广义：LLVM是一个包括了很多模块的编译器框架。</li>
<li>狭义：LLVM特指LLVM项目中的LLVM Core和Clang子模块。</li>
<li>简单来收，可以将LLVM理解成为一个现代化、可扩展的编译器。</li>
</ul>
<h4 id="GCC的编译流程"><a href="#GCC的编译流程" class="headerlink" title="GCC的编译流程"></a>GCC的编译流程</h4><ul>
<li>GCC分为三个模块：前端、优化器和后端</li>
</ul>
<p>暂时无法在文档外展示此内容</p>
<ul>
<li>LLVM本质上也是三段式：</li>
</ul>
<p>暂时无法在文档外展示此内容</p>
<h4 id="LLVM的编译流程"><a href="#LLVM的编译流程" class="headerlink" title="LLVM的编译流程"></a>LLVM的编译流程</h4><ul>
<li>一个具体的例子：</li>
</ul>
<p>暂时无法在文档外展示此内容</p>
<h4 id="LLVM相对于GCC的优势"><a href="#LLVM相对于GCC的优势" class="headerlink" title="LLVM相对于GCC的优势"></a>LLVM相对于GCC的优势</h4><h5 id="优势1：模块化"><a href="#优势1：模块化" class="headerlink" title="优势1：模块化"></a>优势1：模块化</h5><ul>
<li>LLVM：LLVM是高度模块化设计的，每一个模块都可以从LLVM项目中抽离出来单独使用。</li>
<li>GCC：而GCC虽然也是三段式编译，但各个模块之间是难以抽离出来单独使用的。</li>
</ul>
<h5 id="优势2：可扩展"><a href="#优势2：可扩展" class="headerlink" title="优势2：可扩展"></a>优势2：可扩展</h5><ul>
<li>LLVM：LLVM为开发者提供了丰富的API，例如开发者可以通过LLVM Pass框架干预中间代码优化过程，并且配备了完善的文档</li>
<li>GCC：虽然GCC是开源的，但要在GCC的基础上进行扩展门槛很高、难度很大</li>
</ul>
<h4 id="LLVM编译过程总结"><a href="#LLVM编译过程总结" class="headerlink" title="LLVM编译过程总结"></a>LLVM编译过程总结</h4><ul>
<li>对于C&#x2F;C++程序来说，LLVM的编译过程如图所示：<br><img src="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1.png"></li>
</ul>
<h4 id="LLVM环境搭建"><a href="#LLVM环境搭建" class="headerlink" title="LLVM环境搭建"></a>LLVM环境搭建</h4><h5 id="Ubuntu-x2F-LLVM-x2F-CMake版本"><a href="#Ubuntu-x2F-LLVM-x2F-CMake版本" class="headerlink" title="Ubuntu&#x2F;LLVM&#x2F;CMake版本"></a>Ubuntu&#x2F;LLVM&#x2F;CMake版本</h5><ul>
<li>Ubuntu 20.04</li>
<li>LLVM 12.0.1 &#x2F; 9.0.9svn(ndkr21e)</li>
<li>Cmake 3.21.1</li>
</ul>
<h5 id="第一步：下载LLVM-Core和Clang源代码"><a href="#第一步：下载LLVM-Core和Clang源代码" class="headerlink" title="第一步：下载LLVM-Core和Clang源代码"></a>第一步：下载LLVM-Core和Clang源代码</h5><p><a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-12.0.1">https://github.com/llvm/llvm-project/releases/tag/llvmorg-12.0.1</a></p>
<p>clang-12.0.1.src.tar.xz</p>
<p>llvm-12.0.1.src.tar.xz</p>
<p>下载、解压、并重命名，并在同一目录下新建build文件夹，如下：</p>
<p><img src="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/2.png"></p>
<h5 id="第二步：编译LLVM项目"><a href="#第二步：编译LLVM项目" class="headerlink" title="第二步：编译LLVM项目"></a>第二步：编译LLVM项目</h5><p>在同一文件夹内创建build.sh文件，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build </span><br><span class="line"></span><br><span class="line">cmake -G <span class="string">&quot;Unix Makefiles&quot;</span> -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang&quot;</span> -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;X86&quot;</span> -DBUILD_SHARED_LIBS=On ../llvm </span><br><span class="line"></span><br><span class="line">make </span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>cmake 参数解释： </p>
<ul>
<li>-G “Unix Makefiles”：生成Unix下的Makefile </li>
<li>-DLLVM_ENABLE_PROJECTS&#x3D;“clang”：除了 LLVM Core 外，还需要编译的子项目。 </li>
<li>-DLLVM_BUILD_TYPE&#x3D;Release：在cmake里，有四种编译模式：Debug, Release, RelWithDebInfo, 和MinSizeRel。使用 Release 模式编译会节省很多空间。 </li>
<li>-DLLVM_TARGETS_TO_BUILD&#x3D;“X86”：默认是ALL，选择X86可节约很多编译时间。 </li>
<li>-DBUILD_SHARED_LIBS&#x3D;On：指定动态链接 LLVM 的库，可以节省空间。</li>
</ul>
<p><img src="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/3.png"></p>
<p>- </p>
<h4 id="LLVM基本用法"><a href="#LLVM基本用法" class="headerlink" title="LLVM基本用法"></a>LLVM基本用法</h4><h5 id="第一步：将源代码转化成LLVM-IR"><a href="#第一步：将源代码转化成LLVM-IR" class="headerlink" title="第一步：将源代码转化成LLVM IR"></a>第一步：将源代码转化成LLVM IR</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iostream&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Hello World!&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LLVM IR 有两种表现形式，一种是人类可阅读的文本形式，对应文件后缀为 .ll ；另一种是方便机器处 理的二进制格式，对应文件后缀为 .bc 。使用以下命令将源代码转化为 LLVM IR： </p>
<blockquote>
<p>clang -S -emit-llvm hello.cpp -o hello.ll</p>
</blockquote>
<p>或</p>
<blockquote>
<p>clang -c -emit-llvm hello.cpp -o hello.bc</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;hello.cpp&#x27;</span><br><span class="line"></span><br><span class="line">source_filename = &quot;hello.cpp&quot;</span><br><span class="line"></span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line"></span><br><span class="line">target triple = &quot;x86_64-unknown-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&quot;class.std::ios_base::Init&quot; = type &#123; i8 &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::basic_ostream&quot; = type &#123; i32 (...)**, %&quot;class.std::basic_ios&quot; &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::basic_ios&quot; = type &#123; %&quot;class.std::ios_base&quot;, %&quot;class.std::basic_ostream&quot;*, i8, i8, %&quot;class.std::basic_streambuf&quot;*, %&quot;class.std::ctype&quot;*, %&quot;class.std::num_put&quot;*, %&quot;class.std::num_get&quot;* &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::ios_base&quot; = type &#123; i32 (...)**, i64, i64, i32, i32, i32, %&quot;struct.std::ios_base::_Callback_list&quot;*, %&quot;struct.std::ios_base::_Words&quot;, [8 x %&quot;struct.std::ios_base::_Words&quot;], i32, %&quot;struct.std::ios_base::_Words&quot;*, %&quot;class.std::locale&quot; &#125;</span><br><span class="line"></span><br><span class="line">%&quot;struct.std::ios_base::_Callback_list&quot; = type &#123; %&quot;struct.std::ios_base::_Callback_list&quot;*, void (i32, %&quot;class.std::ios_base&quot;*, i32)*, i32, i32 &#125;</span><br><span class="line"></span><br><span class="line">%&quot;struct.std::ios_base::_Words&quot; = type &#123; i8*, i64 &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::locale&quot; = type &#123; %&quot;class.std::locale::_Impl&quot;* &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::locale::_Impl&quot; = type &#123; i32, %&quot;class.std::locale::facet&quot;**, i64, %&quot;class.std::locale::facet&quot;**, i8** &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::locale::facet&quot; = type &lt;&#123; i32 (...)**, i32, [4 x i8] &#125;&gt;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::basic_streambuf&quot; = type &#123; i32 (...)**, i8*, i8*, i8*, i8*, i8*, i8*, %&quot;class.std::locale&quot; &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::ctype&quot; = type &lt;&#123; %&quot;class.std::locale::facet.base&quot;, [4 x i8], %struct.__locale_struct*, i8, [7 x i8], i32*, i32*, i16*, i8, [256 x i8], [256 x i8], i8, [6 x i8] &#125;&gt;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::locale::facet.base&quot; = type &lt;&#123; i32 (...)**, i32 &#125;&gt;</span><br><span class="line"></span><br><span class="line">%struct.__locale_struct = type &#123; [13 x %struct.__locale_data*], i16*, i32*, i32*, [13 x i8*] &#125;</span><br><span class="line"></span><br><span class="line">%struct.__locale_data = type opaque</span><br><span class="line"></span><br><span class="line">%&quot;class.std::num_put&quot; = type &#123; %&quot;class.std::locale::facet.base&quot;, [4 x i8] &#125;</span><br><span class="line"></span><br><span class="line">%&quot;class.std::num_get&quot; = type &#123; %&quot;class.std::locale::facet.base&quot;, [4 x i8] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@_ZStL8__ioinit = internal global %&quot;class.std::ios_base::Init&quot; zeroinitializer, align 1</span><br><span class="line"></span><br><span class="line">@__dso_handle = external hidden global i8</span><br><span class="line"></span><br><span class="line">@_ZSt4cout = external dso_local global %&quot;class.std::basic_ostream&quot;, align 8</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [13 x i8] c&quot;Hello World!\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">@llvm.global_ctors = appending global [1 x &#123; i32, void ()*, i8* &#125;] [&#123; i32, void ()*, i8* &#125; &#123; i32 65535, void ()* @_GLOBAL__sub_I_hello.cpp, i8* null &#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline uwtable</span><br><span class="line"></span><br><span class="line">define internal void @__cxx_global_var_init() #0 section &quot;.text.startup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  call void @_ZNSt8ios_base4InitC1Ev(%&quot;class.std::ios_base::Init&quot;* nonnull dereferenceable(1) @_ZStL8__ioinit)</span><br><span class="line"></span><br><span class="line">  %1 = call i32 @__cxa_atexit(void (i8*)* bitcast (void (%&quot;class.std::ios_base::Init&quot;*)* @_ZNSt8ios_base4InitD1Ev to void (i8*)*), i8* getelementptr inbounds (%&quot;class.std::ios_base::Init&quot;, %&quot;class.std::ios_base::Init&quot;* @_ZStL8__ioinit, i32 0, i32 0), i8* @__dso_handle) #3</span><br><span class="line"></span><br><span class="line">  ret void</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare dso_local void @_ZNSt8ios_base4InitC1Ev(%&quot;class.std::ios_base::Init&quot;* nonnull dereferenceable(1)) unnamed_addr #1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Function Attrs: nounwind</span><br><span class="line"></span><br><span class="line">declare dso_local void @_ZNSt8ios_base4InitD1Ev(%&quot;class.std::ios_base::Init&quot;* nonnull dereferenceable(1)) unnamed_addr #2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Function Attrs: nounwind</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @__cxa_atexit(void (i8*)*, i8*, i8*) #3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline norecurse optnone uwtable mustprogress</span><br><span class="line"></span><br><span class="line">define dso_local i32 @main() #4 &#123;</span><br><span class="line"></span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line"></span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line"></span><br><span class="line">  %2 = call nonnull align 8 dereferenceable(8) %&quot;class.std::basic_ostream&quot;* @_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc(%&quot;class.std::basic_ostream&quot;* nonnull align 8 dereferenceable(8) @_ZSt4cout, i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i64 0, i64 0))</span><br><span class="line"></span><br><span class="line">  %3 = call nonnull align 8 dereferenceable(8) %&quot;class.std::basic_ostream&quot;* @_ZNSolsEPFRSoS_E(%&quot;class.std::basic_ostream&quot;* nonnull dereferenceable(8) %2, %&quot;class.std::basic_ostream&quot;* (%&quot;class.std::basic_ostream&quot;*)* @_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_)</span><br><span class="line"></span><br><span class="line">  ret i32 0</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare dso_local nonnull align 8 dereferenceable(8) %&quot;class.std::basic_ostream&quot;* @_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc(%&quot;class.std::basic_ostream&quot;* nonnull align 8 dereferenceable(8), i8*) #1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare dso_local nonnull align 8 dereferenceable(8) %&quot;class.std::basic_ostream&quot;* @_ZNSolsEPFRSoS_E(%&quot;class.std::basic_ostream&quot;* nonnull dereferenceable(8), %&quot;class.std::basic_ostream&quot;* (%&quot;class.std::basic_ostream&quot;*)*) #1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare dso_local nonnull align 8 dereferenceable(8) %&quot;class.std::basic_ostream&quot;* @_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_(%&quot;class.std::basic_ostream&quot;* nonnull align 8 dereferenceable(8)) #1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline uwtable</span><br><span class="line"></span><br><span class="line">define internal void @_GLOBAL__sub_I_hello.cpp() #0 section &quot;.text.startup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  call void @__cxx_global_var_init()</span><br><span class="line"></span><br><span class="line">  ret void</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline uwtable &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">attributes #1 = &#123; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">attributes #2 = &#123; nounwind &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">attributes #3 = &#123; nounwind &#125;</span><br><span class="line"></span><br><span class="line">attributes #4 = &#123; noinline norecurse optnone uwtable mustprogress &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line"></span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line"></span><br><span class="line">!1 = !&#123;!&quot;clang version 12.0.1&quot;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="第二步：优化LLVM-IR"><a href="#第二步：优化LLVM-IR" class="headerlink" title="第二步：优化LLVM IR"></a>第二步：优化LLVM IR</h5><p>使用opt指令对LLVM IR进行优化</p>
<blockquote>
<p>opt -load LLVMObfuscator.so -hlw -S hello.ll -o hello_opt.ll</p>
</blockquote>
<ul>
<li>-load 加载特定的LLVM Pass（集合）进行优化（通常为.so文件）</li>
<li>-hlw是LLVM Pass中自定义的参数，用来指定使用哪个Pass进行优化</li>
</ul>
<h5 id="第三步：编译LLVM-IR为可执行文件"><a href="#第三步：编译LLVM-IR为可执行文件" class="headerlink" title="第三步：编译LLVM IR为可执行文件"></a>第三步：编译LLVM IR为可执行文件</h5><p>这一步我们通过Clang完成，从LLVM IR到可执行文件中间还有一系列复杂的流程，Clang帮助我们整合了这个过程</p>
<blockquote>
<p>clang hello_opt.ll -o hello</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.kanxue.com/book-section_list-88.htm">https://www.kanxue.com/book-section_list-88.htm</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" data-id="cl8x7xxbm000qe875hwlvei70" data-title="LLVM从小白到放弃（一）- LLVM概述与LLVM环境搭建" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLVM/" rel="tag">LLVM</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-各安卓版本关于loadLibrary函数的实现区别" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/14/%E5%90%84%E5%AE%89%E5%8D%93%E7%89%88%E6%9C%AC%E5%85%B3%E4%BA%8EloadLibrary%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8C%BA%E5%88%AB/" class="article-date">
  <time class="dt-published" datetime="2022-01-14T02:28:25.000Z" itemprop="datePublished">2022-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/01/14/%E5%90%84%E5%AE%89%E5%8D%93%E7%89%88%E6%9C%AC%E5%85%B3%E4%BA%8EloadLibrary%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8C%BA%E5%88%AB/">针对Android App隐私信息检测</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>loadLibrary主要是在Runtime.java中实现，各个版本之间差异比较大，所以做个笔记来整理这些区别。</p>
<h2 id="4-4-版本"><a href="#4-4-版本" class="headerlink" title="4.4 版本"></a>4.4 版本</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/libcore/luni/src/main/java/java/lang/Runtime.java">Cross Reference: &#x2F;libcore&#x2F;luni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<p>主要是这一块：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/libcore/luni/src/main/java/java/lang/Runtime.java#354">http://androidxref.com/4.4.4_r1&#x2F;xref&#x2F;libcore&#x2F;luni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java#354</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libraryName, ClassLoader loader)</span> &#123;</span><br><span class="line"><span class="number">355</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">356</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">357</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">358</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Couldn&#x27;t load &quot;</span> + libraryName +</span><br><span class="line"><span class="number">359</span>                                               <span class="string">&quot; from loader &quot;</span> + loader +</span><br><span class="line"><span class="number">360</span>                                               <span class="string">&quot;: findLibrary returned null&quot;</span>);</span><br><span class="line"><span class="number">361</span>            &#125;</span><br><span class="line"><span class="number">362</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">363</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">364</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">365</span>            &#125;</span><br><span class="line"><span class="number">366</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">367</span>        &#125;</span><br><span class="line"><span class="number">368</span></span><br><span class="line"><span class="number">369</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">370</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">371</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">372</span>        <span class="keyword">for</span> (String directory : mLibPaths) &#123;</span><br><span class="line"><span class="number">373</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">374</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">375</span></span><br><span class="line"><span class="number">376</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">377</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">378</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">379</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">380</span>                &#125;</span><br><span class="line"><span class="number">381</span>                lastError = error;</span><br><span class="line"><span class="number">382</span>            &#125;</span><br><span class="line"><span class="number">383</span>        &#125;</span><br><span class="line"><span class="number">384</span></span><br><span class="line"><span class="number">385</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">386</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">387</span>        &#125;</span><br><span class="line"><span class="number">388</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">389</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>其中关键的一部分代码是这个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">357</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">358</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Couldn&#x27;t load &quot;</span> + libraryName +</span><br><span class="line"><span class="number">359</span>                                               <span class="string">&quot; from loader &quot;</span> + loader +</span><br><span class="line"><span class="number">360</span>                                               <span class="string">&quot;: findLibrary returned null&quot;</span>);</span><br><span class="line"><span class="number">361</span>            &#125;</span><br></pre></td></tr></table></figure>

<p>接着去寻找findLibrary。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java#380">http://androidxref.com/4.4.4_r1&#x2F;xref&#x2F;libcore&#x2F;dalvik&#x2F;src&#x2F;main&#x2F;java&#x2F;dalvik&#x2F;system&#x2F;DexPathList.java#380</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">380</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">381</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">382</span>        <span class="keyword">for</span> (File directory : nativeLibraryDirectories) &#123;</span><br><span class="line"><span class="number">383</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(directory, fileName).getPath();</span><br><span class="line"><span class="number">384</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(path)) &#123;</span><br><span class="line"><span class="number">385</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">386</span>            &#125;</span><br><span class="line"><span class="number">387</span>        &#125;</span><br><span class="line"><span class="number">388</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">389</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>就是将nativeLibraryDirectories变量遍历里面是否包含了要加载的so文件。</p>
<p>来看下nativeLibraryDirectories是怎么得到的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/** List of native library directories. */</span><br><span class="line">private final File[]nativeLibraryDirectories;</span><br></pre></td></tr></table></figure>

<p>是一个File[]数组呢，而且是final的。</p>
<p>但是接着看的话，在DexPathList初始化的时候将这个变量进行赋值：</p>
<ul>
<li>this.nativeLibraryDirectories &#x3D; splitLibraryPath(libraryPath);</li>
</ul>
<h2 id="5-0版本"><a href="#5-0版本" class="headerlink" title="5.0版本"></a>5.0版本</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/5.0.0_r2/xref/libcore/luni/src/main/java/java/lang/Runtime.java">http://androidxref.com/5.0.0_r2&#x2F;xref&#x2F;libcore&#x2F;luni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">358</span>    <span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libraryName, ClassLoader loader)</span> &#123;</span><br><span class="line"><span class="number">359</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">360</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">361</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">362</span>                <span class="comment">// It&#x27;s not necessarily true that the ClassLoader used</span></span><br><span class="line"><span class="number">363</span>                <span class="comment">// System.mapLibraryName, but the default setup does, and it&#x27;s</span></span><br><span class="line"><span class="number">364</span>                <span class="comment">// misleading to say we didn&#x27;t find &quot;libMyLibrary.so&quot; when we</span></span><br><span class="line"><span class="number">365</span>                <span class="comment">// actually searched for &quot;liblibMyLibrary.so.so&quot;.</span></span><br><span class="line"><span class="number">366</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(loader + <span class="string">&quot; couldn&#x27;t find \\&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">367                                               System.mapLibraryName(libraryName) + &quot;</span>\\<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="number">368</span>            &#125;</span><br><span class="line"><span class="number">369</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">370</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">371</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">372</span>            &#125;</span><br><span class="line"><span class="number">373</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">374</span>        &#125;</span><br><span class="line"><span class="number">375</span></span><br><span class="line"><span class="number">376</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">377</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">378</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">379</span>        <span class="keyword">for</span> (String directory : mLibPaths) &#123;</span><br><span class="line"><span class="number">380</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">381</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">382</span></span><br><span class="line"><span class="number">383</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">384</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">385</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">386</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">387</span>                &#125;</span><br><span class="line"><span class="number">388</span>                lastError = error;</span><br><span class="line"><span class="number">389</span>            &#125;</span><br><span class="line"><span class="number">390</span>        &#125;</span><br><span class="line"><span class="number">391</span></span><br><span class="line"><span class="number">392</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">393</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">394</span>        &#125;</span><br><span class="line"><span class="number">395</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">396</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>findLibrary:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">379</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">380</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">381</span>        <span class="keyword">for</span> (File directory : nativeLibraryDirectories) &#123;</span><br><span class="line"><span class="number">382</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(directory, fileName).getPath();</span><br><span class="line"><span class="number">383</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(path)) &#123;</span><br><span class="line"><span class="number">384</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">385</span>            &#125;</span><br><span class="line"><span class="number">386</span>        &#125;</span><br><span class="line"><span class="number">387</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">388</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>nativeLibraryDirectories:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/** List of native library directories. */</span><br><span class="line">private final File[]nativeLibraryDirectories;</span><br></pre></td></tr></table></figure>

<p>也还是File数组且为final。</p>
<p>最后赋值也是跟4.4一样：</p>
<ul>
<li>this.nativeLibraryDirectories &#x3D; splitLibraryPath(libraryPath);</li>
</ul>
<h2 id="5-1版本"><a href="#5-1版本" class="headerlink" title="5.1版本"></a>5.1版本</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/5.1.1_r6/xref/libcore/luni/src/main/java/java/lang/Runtime.java">http://androidxref.com/5.1.1_r6&#x2F;xref&#x2F;libcore&#x2F;luni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">358</span>    <span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libraryName, ClassLoader loader)</span> &#123;</span><br><span class="line"><span class="number">359</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">360</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">361</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">362</span>                <span class="comment">// It&#x27;s not necessarily true that the ClassLoader used</span></span><br><span class="line"><span class="number">363</span>                <span class="comment">// System.mapLibraryName, but the default setup does, and it&#x27;s</span></span><br><span class="line"><span class="number">364</span>                <span class="comment">// misleading to say we didn&#x27;t find &quot;libMyLibrary.so&quot; when we</span></span><br><span class="line"><span class="number">365</span>                <span class="comment">// actually searched for &quot;liblibMyLibrary.so.so&quot;.</span></span><br><span class="line"><span class="number">366</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(loader + <span class="string">&quot; couldn&#x27;t find \\&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">367                                               System.mapLibraryName(libraryName) + &quot;</span>\\<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="number">368</span>            &#125;</span><br><span class="line"><span class="number">369</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">370</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">371</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">372</span>            &#125;</span><br><span class="line"><span class="number">373</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">374</span>        &#125;</span><br><span class="line"><span class="number">375</span></span><br><span class="line"><span class="number">376</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">377</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">378</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">379</span>        <span class="keyword">for</span> (String directory : mLibPaths) &#123;</span><br><span class="line"><span class="number">380</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">381</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">382</span></span><br><span class="line"><span class="number">383</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">384</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">385</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">386</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">387</span>                &#125;</span><br><span class="line"><span class="number">388</span>                lastError = error;</span><br><span class="line"><span class="number">389</span>            &#125;</span><br><span class="line"><span class="number">390</span>        &#125;</span><br><span class="line"><span class="number">391</span></span><br><span class="line"><span class="number">392</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">393</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">394</span>        &#125;</span><br><span class="line"><span class="number">395</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">396</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>findLibrary:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">379</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">380</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">381</span>        <span class="keyword">for</span> (File directory : nativeLibraryDirectories) &#123;</span><br><span class="line"><span class="number">382</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(directory, fileName).getPath();</span><br><span class="line"><span class="number">383</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(path)) &#123;</span><br><span class="line"><span class="number">384</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">385</span>            &#125;</span><br><span class="line"><span class="number">386</span>        &#125;</span><br><span class="line"><span class="number">387</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">388</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>nativeLibraryDirectories:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/** List of native library directories. */</span><br><span class="line">private final File[] nativeLibraryDirectories;</span><br></pre></td></tr></table></figure>

<ul>
<li>this.nativeLibraryDirectories &#x3D; splitLibraryPath(libraryPath);</li>
<li>private static File[] splitLibraryPath(String path)</li>
</ul>
<h2 id="6-0版本"><a href="#6-0版本" class="headerlink" title="6.0版本"></a>6.0版本</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/xref/libcore/luni/src/main/java/java/lang/Runtime.java">http://androidxref.com/6.0.1_r10&#x2F;xref&#x2F;libcore&#x2F;luni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">359</span>    <span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libraryName, ClassLoader loader)</span> &#123;</span><br><span class="line"><span class="number">360</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">361</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">362</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">363</span>                <span class="comment">// It&#x27;s not necessarily true that the ClassLoader used</span></span><br><span class="line"><span class="number">364</span>                <span class="comment">// System.mapLibraryName, but the default setup does, and it&#x27;s</span></span><br><span class="line"><span class="number">365</span>                <span class="comment">// misleading to say we didn&#x27;t find &quot;libMyLibrary.so&quot; when we</span></span><br><span class="line"><span class="number">366</span>                <span class="comment">// actually searched for &quot;liblibMyLibrary.so.so&quot;.</span></span><br><span class="line"><span class="number">367</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(loader + <span class="string">&quot; couldn&#x27;t find \\&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">368                                               System.mapLibraryName(libraryName) + &quot;</span>\\<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="number">369</span>            &#125;</span><br><span class="line"><span class="number">370</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">371</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">372</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">373</span>            &#125;</span><br><span class="line"><span class="number">374</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">375</span>        &#125;</span><br><span class="line"><span class="number">376</span></span><br><span class="line"><span class="number">377</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">378</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">379</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">380</span>        <span class="keyword">for</span> (String directory : mLibPaths) &#123;</span><br><span class="line"><span class="number">381</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">382</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">383</span></span><br><span class="line"><span class="number">384</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">385</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">386</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">387</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">388</span>                &#125;</span><br><span class="line"><span class="number">389</span>                lastError = error;</span><br><span class="line"><span class="number">390</span>            &#125;</span><br><span class="line"><span class="number">391</span>        &#125;</span><br><span class="line"><span class="number">392</span></span><br><span class="line"><span class="number">393</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">394</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">395</span>        &#125;</span><br><span class="line"><span class="number">396</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">397</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>findLibrary：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">396</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">397</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">398</span></span><br><span class="line"><span class="number">399</span>        <span class="keyword">for</span> (Element element : nativeLibraryPathElements) &#123;</span><br><span class="line"><span class="number">400</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> element.findNativeLibrary(fileName);</span><br><span class="line"><span class="number">401</span></span><br><span class="line"><span class="number">402</span>            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">403</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">404</span>            &#125;</span><br><span class="line"><span class="number">405</span>        &#125;</span><br><span class="line"><span class="number">406</span></span><br><span class="line"><span class="number">407</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">408</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>nativeLibraryPathElements，从6.0开始好像就有了nativeLibraryPathElements这个属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/** List of native library path elements. */</span><br><span class="line">private final Element[] nativeLibraryPathElements;</span><br></pre></td></tr></table></figure>

<p>从这里开始复制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.nativeLibraryPathElements = makePathElements(allNativeLibraryDirectories, <span class="literal">null</span>,</span><br><span class="line">                                                      suppressedExceptions);</span><br></pre></td></tr></table></figure>

<p>然后makePathElements:</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Element[] makePathElements(List&lt;<span class="keyword">File</span>&gt;files,<span class="keyword">File</span> optimizedDirectory,List&lt;IOException&gt;suppressedExceptions)</span><br></pre></td></tr></table></figure>

<p>属性就可以了。</p>
<h2 id="7-0版本"><a href="#7-0版本" class="headerlink" title="7.0版本"></a>7.0版本</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.0.0_r1/xref/libcore/ojluni/src/main/java/java/lang/Runtime.java">http://androidxref.com/7.0.0_r1&#x2F;xref&#x2F;libcore&#x2F;ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<p>从7.0开始增加了loadLibrary0这个函数，其实就是将之前的loadLibrary改成了这个，其实都一个作用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">959</span>    <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">loadLibrary0</span><span class="params">(ClassLoader loader, String libname)</span> &#123;</span><br><span class="line"><span class="number">960</span>        <span class="keyword">if</span> (libname.indexOf((<span class="type">int</span>)File.separatorChar) != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">961</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(</span><br><span class="line"><span class="number">962</span>    <span class="string">&quot;Directory separator should not appear in library name: &quot;</span> + libname);</span><br><span class="line"><span class="number">963</span>        &#125;</span><br><span class="line"><span class="number">964</span>        <span class="type">String</span> <span class="variable">libraryName</span> <span class="operator">=</span> libname;</span><br><span class="line"><span class="number">965</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">966</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">967</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">968</span>                <span class="comment">// It&#x27;s not necessarily true that the ClassLoader used</span></span><br><span class="line"><span class="number">969</span>                <span class="comment">// System.mapLibraryName, but the default setup does, and it&#x27;s</span></span><br><span class="line"><span class="number">970</span>                <span class="comment">// misleading to say we didn&#x27;t find &quot;libMyLibrary.so&quot; when we</span></span><br><span class="line"><span class="number">971</span>                <span class="comment">// actually searched for &quot;liblibMyLibrary.so.so&quot;.</span></span><br><span class="line"><span class="number">972</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(loader + <span class="string">&quot; couldn&#x27;t find \\&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">973                                               System.mapLibraryName(libraryName) + &quot;</span>\\<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="number">974</span>            &#125;</span><br><span class="line"><span class="number">975</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">976</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">977</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">978</span>            &#125;</span><br><span class="line"><span class="number">979</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">980</span>        &#125;</span><br><span class="line"><span class="number">981</span></span><br><span class="line"><span class="number">982</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">983</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">984</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">985</span>        <span class="keyword">for</span> (String directory : getLibPaths()) &#123;</span><br><span class="line"><span class="number">986</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">987</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">988</span></span><br><span class="line"><span class="number">989</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">990</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">991</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">992</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">993</span>                &#125;</span><br><span class="line"><span class="number">994</span>                lastError = error;</span><br><span class="line"><span class="number">995</span>            &#125;</span><br><span class="line"><span class="number">996</span>        &#125;</span><br><span class="line"><span class="number">997</span></span><br><span class="line"><span class="number">998</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">999</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">1000</span>        &#125;</span><br><span class="line"><span class="number">1001</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">1002</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>findLibrary：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">476</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">477</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">478</span></span><br><span class="line"><span class="number">479</span>        <span class="keyword">for</span> (Element element : nativeLibraryPathElements) &#123;</span><br><span class="line"><span class="number">480</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> element.findNativeLibrary(fileName);</span><br><span class="line"><span class="number">481</span></span><br><span class="line"><span class="number">482</span>            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">483</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">484</span>            &#125;</span><br><span class="line"><span class="number">485</span>        &#125;</span><br><span class="line"><span class="number">486</span></span><br><span class="line"><span class="number">487</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">488</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>nativeLibraryPathElements:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/** List of native library path elements. */</span><br><span class="line">private final Element[]nativeLibraryPathElements;</span><br></pre></td></tr></table></figure>

<p>怎么赋值的呢：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">145</span>        <span class="built_in">this</span>.nativeLibraryPathElements = makePathElements(allNativeLibraryDirectories,</span><br><span class="line"><span class="number">146</span>                                                          suppressedExceptions,</span><br><span class="line"><span class="number">147</span>                                                          definingContext);</span><br></pre></td></tr></table></figure>

<p>又进行了改变</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">269</span>    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makePathElements(List&lt;File&gt; files,</span><br><span class="line"><span class="number">270</span>                                              List&lt;IOException&gt; suppressedExceptions,</span><br><span class="line"><span class="number">271</span>                                              ClassLoader loader)</span><br></pre></td></tr></table></figure>

<p>之前6.0的两个list和一个file，又改成了两个list和一个classloader</p>
<p>7.1跟7.0一样不赘述。</p>
<h2 id="8-0"><a href="#8-0" class="headerlink" title="8.0"></a>8.0</h2><p>源码：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/lang/Runtime.java">http://androidxref.com/8.1.0_r33&#x2F;xref&#x2F;libcore&#x2F;ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;lang&#x2F;Runtime.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">998</span>    <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">loadLibrary0</span><span class="params">(ClassLoader loader, String libname)</span> &#123;</span><br><span class="line"><span class="number">999</span>        <span class="keyword">if</span> (libname.indexOf((<span class="type">int</span>)File.separatorChar) != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">1000</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(</span><br><span class="line"><span class="number">1001</span>    <span class="string">&quot;Directory separator should not appear in library name: &quot;</span> + libname);</span><br><span class="line"><span class="number">1002</span>        &#125;</span><br><span class="line"><span class="number">1003</span>        <span class="type">String</span> <span class="variable">libraryName</span> <span class="operator">=</span> libname;</span><br><span class="line"><span class="number">1004</span>        <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">1005</span>            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> loader.findLibrary(libraryName);</span><br><span class="line"><span class="number">1006</span>            <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">1007</span>                <span class="comment">// It&#x27;s not necessarily true that the ClassLoader used</span></span><br><span class="line"><span class="number">1008</span>                <span class="comment">// System.mapLibraryName, but the default setup does, and it&#x27;s</span></span><br><span class="line"><span class="number">1009</span>                <span class="comment">// misleading to say we didn&#x27;t find &quot;libMyLibrary.so&quot; when we</span></span><br><span class="line"><span class="number">1010</span>                <span class="comment">// actually searched for &quot;liblibMyLibrary.so.so&quot;.</span></span><br><span class="line"><span class="number">1011</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(loader + <span class="string">&quot; couldn&#x27;t find \\&quot;</span><span class="string">&quot; +</span></span><br><span class="line"><span class="string">1012                                               System.mapLibraryName(libraryName) + &quot;</span>\\<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="number">1013</span>            &#125;</span><br><span class="line"><span class="number">1014</span>            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(filename, loader);</span><br><span class="line"><span class="number">1015</span>            <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">1016</span>                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line"><span class="number">1017</span>            &#125;</span><br><span class="line"><span class="number">1018</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">1019</span>        &#125;</span><br><span class="line"><span class="number">1020</span></span><br><span class="line"><span class="number">1021</span>        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">1022</span>        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"><span class="number">1023</span>        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">1024</span>        <span class="keyword">for</span> (String directory : getLibPaths()) &#123;</span><br><span class="line"><span class="number">1025</span>            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line"><span class="number">1026</span>            candidates.add(candidate);</span><br><span class="line"><span class="number">1027</span></span><br><span class="line"><span class="number">1028</span>            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line"><span class="number">1029</span>                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> doLoad(candidate, loader);</span><br><span class="line"><span class="number">1030</span>                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">1031</span>                    <span class="keyword">return</span>; <span class="comment">// We successfully loaded the library. Job done.</span></span><br><span class="line"><span class="number">1032</span>                &#125;</span><br><span class="line"><span class="number">1033</span>                lastError = error;</span><br><span class="line"><span class="number">1034</span>            &#125;</span><br><span class="line"><span class="number">1035</span>        &#125;</span><br><span class="line"><span class="number">1036</span></span><br><span class="line"><span class="number">1037</span>        <span class="keyword">if</span> (lastError != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">1038</span>            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(lastError);</span><br><span class="line"><span class="number">1039</span>        &#125;</span><br><span class="line"><span class="number">1040</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(<span class="string">&quot;Library &quot;</span> + libraryName + <span class="string">&quot; not found; tried &quot;</span> + candidates);</span><br><span class="line"><span class="number">1041</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>findLibrary:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">524</span>    <span class="keyword">public</span> String <span class="title function_">findLibrary</span><span class="params">(String libraryName)</span> &#123;</span><br><span class="line"><span class="number">525</span>        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line"><span class="number">526</span></span><br><span class="line"><span class="number">527</span>        <span class="keyword">for</span> (NativeLibraryElement element : nativeLibraryPathElements) &#123;</span><br><span class="line"><span class="number">528</span>            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> element.findNativeLibrary(fileName);</span><br><span class="line"><span class="number">529</span></span><br><span class="line"><span class="number">530</span>            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">531</span>                <span class="keyword">return</span> path;</span><br><span class="line"><span class="number">532</span>            &#125;</span><br><span class="line"><span class="number">533</span>        &#125;</span><br><span class="line"><span class="number">534</span></span><br><span class="line"><span class="number">535</span>        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">536</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>怎么赋值的呢</p>
<ul>
<li>this.nativeLibraryPathElements &#x3D; makePathElements(this.systemNativeLibraryDirectories);</li>
</ul>
<p>然后makePathElements:</p>
<ul>
<li>private static NativeLibraryElement[] makePathElements(List<File> files)</li>
</ul>
<p>返回值改了，参数也改了。</p>
<p>就很纳闷，google这帮人不干实事整天改这个干嘛，有漏洞？</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>4.4 ～5.1</p>
<p>都是使用的</p>
<blockquote>
<p>this.nativeLibraryDirectories &#x3D; splitLibraryPath(libraryPath);</p>
</blockquote>
<blockquote>
<p>private static File[] splitLibraryPath(String path)</p>
</blockquote>
<p>6.0</p>
<blockquote>
<p>this.<a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/xref/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java#nativeLibraryPathElements">nativeLibraryPathElements</a> &#x3D; <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/xref/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java#makePathElements">makePathElements</a>(<a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=allNativeLibraryDirectories&project=libcore">allNativeLibraryDirectories</a>, <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=null&project=libcore">null</a>,<a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/xref/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java#suppressedExceptions">suppressedExceptions</a>);</p>
</blockquote>
<blockquote>
<p>private static <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=Element&project=libcore">Element</a>[] <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?refs=makePathElements&project=libcore">makePathElements</a>(<a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=List&project=libcore">List</a><a href="%5BFile%5D(http://androidxref.com/6.0.1_r10/s?defs=File&project=libcore)"><a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=File&project=libcore">File</a></a> <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?refs=files&project=libcore">files</a>, <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=File&project=libcore">File</a> <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?refs=optimizedDirectory&project=libcore">optimizedDirectory</a>,<a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=List&project=libcore">List</a><a href="%5BIOException%5D(http://androidxref.com/6.0.1_r10/s?defs=IOException&project=libcore)"><a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/s?defs=IOException&project=libcore">IOException</a></a> <a target="_blank" rel="noopener" href="http://androidxref.com/6.0.1_r10/xref/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java#suppressedExceptions">suppressedExceptions</a>)</p>
</blockquote>
<p>7.0 ~ 7.1</p>
<blockquote>
<p>this.nativeLibraryPathElements &#x3D; makePathElements(allNativeLibraryDirectories, suppressedExceptions, definingContext);</p>
</blockquote>
<blockquote>
<p>private static Element[] makePathElements(List<File> files, List<IOException> suppressedExceptions, ClassLoader loader)</p>
</blockquote>
<p>8.0 ~ 8.1</p>
<blockquote>
<p>this.nativeLibraryPathElements &#x3D; makePathElements(this.systemNativeLibraryDirectories);</p>
</blockquote>
<blockquote>
<p>private static NativeLibraryElement[] makePathElements(List<File> files)</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2022/01/14/%E5%90%84%E5%AE%89%E5%8D%93%E7%89%88%E6%9C%AC%E5%85%B3%E4%BA%8EloadLibrary%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8C%BA%E5%88%AB/" data-id="cl8x7xxbo000ue875b1cob8of" data-title="针对Android App隐私信息检测" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-针对Android_App隐私信息检测" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/30/%E9%92%88%E5%AF%B9Android_App%E9%9A%90%E7%A7%81%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B/" class="article-date">
  <time class="dt-published" datetime="2021-12-30T02:28:25.000Z" itemprop="datePublished">2021-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/12/30/%E9%92%88%E5%AF%B9Android_App%E9%9A%90%E7%A7%81%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B/">针对Android App隐私信息检测</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>尝试采用Frida进行处理。</p>
<p>目前的一个思路就是trace app中所有调用系统函数的功能，这个方法不够细致，无法判断是app自身调用的还是app调用的sdk调用的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhengjim/camille">https://github.com/zhengjim/camille</a></p>
<p>昨天尝试了下，发现并没有多好使，还需要继续研究下，自己写个demo试试。</p>
<p>只需要hook相应的隐私API就算是触犯了隐私信息的采集了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取手机通信录</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPhoneAddressBook</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contacts_uri = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.provider.ContactsContract$Contacts&quot;</span>).<span class="property">CONTENT_URI</span>.<span class="property">value</span>.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentResolver = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.content.ContentResolver&quot;</span>);</span><br><span class="line"></span><br><span class="line">    contentResolver.<span class="property">query</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.net.Uri&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;android.os.Bundle&#x27;</span>, <span class="string">&#x27;android.os.CancellationSignal&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">uri, str, bundle, sig</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uri == contacts_uri) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">alertSend</span>(<span class="string">&quot;获取手机通信录&quot;</span>, <span class="string">&quot;获取uri为：&quot;</span> + uri)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">query</span>(uri, str, bundle, sig);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以了，无非就是看隐私API都有哪些，有了就行了</p>
<p>还有就是如果是这种写死的方式的话，可能不太方便不适合维护，所以，需要一个单独的接口传入类、类中的函数名，就能够批次hook即可。</p>
<p>可以参考这个：<a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer">https://github.com/r0ysue/r0tracer</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; alertSend2 &#125; <span class="keyword">from</span> <span class="string">&quot;./alertSend&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isLite = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// trace单个类的所有静态和实例方法包括构造方法 trace a specific Java Method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traceMethod</span>(<span class="params">targetClassMethod: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> delim = targetClassMethod.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (delim === -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetClass = targetClassMethod.<span class="title function_">slice</span>(<span class="number">0</span>, delim)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetMethod = targetClassMethod.<span class="title function_">slice</span>(delim + <span class="number">1</span>, targetClassMethod.<span class="property">length</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> hook = <span class="title class_">Java</span>.<span class="title function_">use</span>(targetClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> overloadCount = hook[targetMethod].<span class="property">overloads</span>.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overloadCount; i++) &#123;</span><br><span class="line"></span><br><span class="line">        hook[targetMethod].<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化输出</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> output = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> args = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> retvalContent = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> stackTrace = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//进入函数</span></span><br><span class="line"></span><br><span class="line">            output = output.<span class="title function_">concat</span>(<span class="string">&quot;\n*** entered &quot;</span> + targetClassMethod);</span><br><span class="line"></span><br><span class="line">            output = output.<span class="title function_">concat</span>(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//参数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> retval = <span class="variable language_">this</span>[targetMethod].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isLite) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 入参</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="variable language_">arguments</span>.<span class="property">length</span>; j++) &#123;</span><br><span class="line"></span><br><span class="line">                    args = args.<span class="title function_">concat</span>(<span class="string">&quot;arg[&quot;</span> + j + <span class="string">&quot;]: &quot;</span> + <span class="variable language_">arguments</span>[j] + <span class="string">&quot; =&gt; &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>[j]));</span><br><span class="line"></span><br><span class="line">                    args = args.<span class="title function_">concat</span>(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//调用栈</span></span><br><span class="line"></span><br><span class="line">                stackTrace = stackTrace.<span class="title function_">concat</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//返回值</span></span><br><span class="line"></span><br><span class="line">                retvalContent = retvalContent.<span class="title function_">concat</span>(<span class="string">&quot;\nretval: &quot;</span> + retval + <span class="string">&quot; =&gt; &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(retval));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">alertSend2</span>(<span class="string">&quot;&quot;</span>, targetClassMethod, args, retvalContent, stackTrace);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">traceClassMethod</span>(<span class="params">params: <span class="built_in">Map</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>[]&gt;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        params.<span class="title function_">forEach</span>(<span class="function">(<span class="params">methodNames, targetClass</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Java.use是新建一个对象哈，大家还记得么？</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> hook = <span class="title class_">Java</span>.<span class="title function_">use</span>(targetClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//利用反射的方式，拿到当前类的所有方法</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> methods = hook.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//建完对象之后记得将对象释放掉哈</span></span><br><span class="line"></span><br><span class="line">            hook.<span class="property">$dispose</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将方法名保存到数组中</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> parsedMethods = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"></span><br><span class="line">            methods.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">method: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">                methodNames.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">methodName</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (method.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(methodName) != -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        parsedMethods.<span class="title function_">add</span>(method.<span class="title function_">toString</span>().<span class="title function_">replace</span>(targetClass + <span class="string">&quot;.&quot;</span>, <span class="string">&quot;TOKEN&quot;</span>).<span class="title function_">match</span>(<span class="regexp">/\sTOKEN(.*)\(/</span>)[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//对数组中所有的方法进行hook，</span></span><br><span class="line"></span><br><span class="line">            parsedMethods.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">targetMethod: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="title function_">traceMethod</span>(targetClass + <span class="string">&quot;.&quot;</span> + targetMethod);</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; traceClassMethod&#125; <span class="keyword">from</span> <span class="string">&quot;./trace&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;隐私合规检测敏感接口开始监控...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send</span>(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;isHook&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>[]&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// class methods</span></span><br><span class="line"></span><br><span class="line">    map.<span class="title function_">set</span>(<span class="string">&quot;android.app.ApplicationPackageManager&quot;</span>, [<span class="string">&quot;getInstalledPackages&quot;</span>, <span class="string">&quot;getInstalledApplications&quot;</span>, <span class="string">&quot;queryIntentActivities&quot;</span>, <span class="string">&quot;getApplicationInfo&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    map.<span class="title function_">set</span>(<span class="string">&quot;android.media.AudioRecord&quot;</span>, [<span class="string">&quot;startRecording&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">traceClassMethod</span>(map);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">alertSend2</span>(<span class="params">action: <span class="built_in">string</span>, className: <span class="built_in">string</span>, input: <span class="built_in">string</span>, output: <span class="built_in">string</span>, stackTrace: <span class="built_in">string</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> myDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _time = myDate.<span class="title function_">getFullYear</span>() + <span class="string">&quot;-&quot;</span> + myDate.<span class="title function_">getMonth</span>() + <span class="string">&quot;-&quot;</span> + myDate.<span class="title function_">getDate</span>() + <span class="string">&quot; &quot;</span> + myDate.<span class="title function_">getHours</span>() + <span class="string">&quot;:&quot;</span> + myDate.<span class="title function_">getMinutes</span>() + <span class="string">&quot;:&quot;</span> + myDate.<span class="title function_">getSeconds</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send</span>(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;notice&quot;</span>, <span class="string">&quot;time&quot;</span>: _time, <span class="string">&quot;action&quot;</span>: action, <span class="string">&quot;className&quot;</span>: className, <span class="string">&quot;input&quot;</span>: input, <span class="string">&quot;output&quot;</span>: output, <span class="string">&quot;stacks&quot;</span>: stackTrace&#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="keyword">from</span> screen <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="title function_">frida_hook</span>(app_name, wait_time=<span class="number">0</span>):</span><br><span class="line"></span><br><span class="line">    #isHook = <span class="title class_">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def <span class="title function_">my_message_handler</span>(message, payload):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;error&quot;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="title function_">print</span>(message)</span><br><span class="line"></span><br><span class="line">            os.<span class="title function_">kill</span>(os.<span class="title function_">getpid</span>(), signal.<span class="property">SIGTERM</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            data = message[<span class="string">&quot;payload&quot;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&quot;notice&quot;</span>:</span><br><span class="line"></span><br><span class="line">                #<span class="title function_">take_screenshot</span>(<span class="title class_">None</span>, app_name + <span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">                alert_time = data[<span class="string">&#x27;time&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                action = data[<span class="string">&#x27;action&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                className = data[<span class="string">&#x27;className&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                input1 = data[<span class="string">&#x27;input&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                output1 = data[<span class="string">&#x27;output&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                stacks = data[<span class="string">&#x27;stacks&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                # todo，以后将这些数据发送给后端，最好就是保存这些数据，并将图片的位置跟这些数据存储在一起。</span><br><span class="line"></span><br><span class="line">                <span class="title function_">print</span>(<span class="string">&quot;------------------------------start---------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="title function_">print</span>(<span class="string">&quot;[*] 行为时间：\n&#123;0&#125;，\nAPP行为：\n&#123;1&#125;，\n类名：\n&#123;2&#125;，\n入参：\n&#123;3&#125;，\n出参：&#123;4&#125;\n&quot;</span>.<span class="title function_">format</span>(alert_time, action, className, input1, output1))</span><br><span class="line"></span><br><span class="line">                <span class="title function_">print</span>(<span class="string">&quot;[*] 调用堆栈：&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="title function_">print</span>(stacks)</span><br><span class="line"></span><br><span class="line">                <span class="title function_">print</span>(<span class="string">&quot;-------------------------------end----------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&quot;app_name&quot;</span>:</span><br><span class="line"></span><br><span class="line">                get_app_name = data[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                my_data = <span class="title class_">False</span> <span class="keyword">if</span> get_app_name == app_name <span class="keyword">else</span> <span class="title class_">True</span></span><br><span class="line"></span><br><span class="line">                script.<span class="title function_">post</span>(&#123;<span class="string">&quot;my_data&quot;</span>: my_data&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&quot;isHook&quot;</span>:</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">global</span> isHook</span><br><span class="line"></span><br><span class="line">                isHook = <span class="title class_">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #session = <span class="title class_">None</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">try</span>:</span><br><span class="line"></span><br><span class="line">        device = frida.<span class="title function_">get_usb_device</span>()</span><br><span class="line"></span><br><span class="line">        pid = device.<span class="title function_">spawn</span>([app_name])</span><br><span class="line"></span><br><span class="line">    except <span class="title class_">Exception</span> <span class="keyword">as</span> <span class="attr">e</span>:</span><br><span class="line"></span><br><span class="line">        <span class="title function_">print</span>(<span class="string">&quot;[*] hook error&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">print</span>(e)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">exit</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    time.<span class="title function_">sleep</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    session = device.<span class="title function_">attach</span>(pid)</span><br><span class="line"></span><br><span class="line">    time.<span class="title function_">sleep</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&quot;../frida-agent-example/_agent.js&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line"></span><br><span class="line">        script_read = f.<span class="title function_">read</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    script = session.<span class="title function_">create_script</span>(script_read)</span><br><span class="line"></span><br><span class="line">    script.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line"></span><br><span class="line">    script.<span class="title function_">load</span>()</span><br><span class="line"></span><br><span class="line">    time.<span class="title function_">sleep</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="attr">try</span>:</span><br><span class="line"></span><br><span class="line">        device.<span class="title function_">resume</span>(pid)</span><br><span class="line"></span><br><span class="line">    except <span class="title class_">Exception</span> <span class="keyword">as</span> <span class="attr">e</span>:</span><br><span class="line"></span><br><span class="line">        <span class="title function_">print</span>(<span class="string">&quot;[*] hook error&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">print</span>(e)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">exit</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 等待frida-server发送消息过来，确保是否已经完成attach</span><br><span class="line"></span><br><span class="line">    wait_time += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    time.<span class="title function_">sleep</span>(wait_time)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="attr">isHook</span>:</span><br><span class="line"></span><br><span class="line">        def <span class="title function_">stop</span>(signum, frame):</span><br><span class="line"></span><br><span class="line">            <span class="title function_">print</span>(<span class="string">&#x27;[*] You have stoped hook.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            session.<span class="title function_">detach</span>()</span><br><span class="line"></span><br><span class="line">            <span class="title function_">exit</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        signal.<span class="title function_">signal</span>(signal.<span class="property">SIGINT</span>, stop)</span><br><span class="line"></span><br><span class="line">        signal.<span class="title function_">signal</span>(signal.<span class="property">SIGTERM</span>, stop)</span><br><span class="line"></span><br><span class="line">        sys.<span class="property">stdin</span>.<span class="title function_">read</span>()</span><br><span class="line"></span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="title function_">print</span>(<span class="string">&quot;[*] hook fail, try delaying hook, adjusting delay time&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;start frida hook&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 全局变量</span><br><span class="line"></span><br><span class="line">    isHook = <span class="title class_">False</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">frida_hook</span>(<span class="string">&quot;com.mepride.freepods&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;end&quot;</span>)</span><br></pre></td></tr></table></figure>





<p><img src="/2021/12/30/%E9%92%88%E5%AF%B9Android_App%E9%9A%90%E7%A7%81%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B/1.png"></p>
<p>针对这种spawn不上的</p>
<p><img src="/2021/12/30/%E9%92%88%E5%AF%B9Android_App%E9%9A%90%E7%A7%81%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B/2.png"></p>
<p>attach也不行的</p>
<p>Bypass ：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> <span class="title function_">ByPassTracerPid</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> fgetsPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != fgetsPtr) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> fgets = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(fgetsPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">buffer, size, fp</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> retval = <span class="title function_">fgets</span>(buffer, size, fp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> bufstr = <span class="title function_">readMemory</span>(buffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//var bufstr = buffer?.toString();</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != bufstr) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bufstr.<span class="title function_">indexOf</span>(<span class="string">&quot;TracerPid:&quot;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="title function_">writeMemory</span>(buffer, <span class="string">&quot;TracerPid:\t0&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tracerpid replaced: &quot;</span> + <span class="title function_">readMemory</span>(buffer));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeMemory</span>(<span class="params">addr: NativePointer, str: <span class="built_in">string</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(addr, str.<span class="property">length</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    addr.<span class="title function_">writeUtf8String</span>(str);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readMemory</span>(<span class="params">addr: NativePointer</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr.<span class="title function_">readUtf8String</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace-engine">https://github.com/chame1eon/jnitrace-engine</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/deathmemory/FridaContainer">https://github.com/deathmemory/FridaContainer</a></p>
<p><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">https://frida.re/docs/javascript-api/</a></p>
<ol>
<li>稳定的frida环境 &#x3D;&gt; 8 + 12.8.0 \ 10 + 14.2.18</li>
<li>Trace jni <a target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace-engine">https://github.com/chame1eon/jnitrace-engine</a></li>
<li>Bypass anti frida</li>
<li>Bypass ssl panning <a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0capture">https://github.com/r0ysue/r0capture</a></li>
</ol>
<p>Bypass anti frida</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">antiAntiFrida</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> strstr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;strstr&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strstr !== <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(strstr, &#123;</span><br><span class="line"></span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="title class_">Boolean</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">haystack</span> = args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">needle</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>() !== <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="title function_">readCString</span>() !== <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;frida&quot;</span>) !== -<span class="number">1</span> || <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;frida&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gum-js-loop&quot;</span>) !== -<span class="number">1</span> || <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gum-js-loop&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gmain&quot;</span>) !== -<span class="number">1</span> || <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;gmain&quot;</span>) !== -<span class="number">1</span> ||</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;linjector&quot;</span>) !== -<span class="number">1</span> || <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;linjector&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="title class_">Boolean</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">frida</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    retval.<span class="title function_">replace</span>(<span class="title function_">ptr</span>(<span class="string">&quot;0x0&quot;</span>));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;anti anti-frida&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Bypass ssl pinning：<a target="_blank" rel="noopener" href="https://github.com/sensepost/objection/blob/master/agent/src/android/pinning.ts">https://github.com/sensepost/objection/blob/master/agent/src/android/pinning.ts</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; wrapJavaPerform &#125; <span class="keyword">from</span> <span class="string">&quot;./libjava&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">ArrayList</span>, <span class="title class_">CertificatePinner</span>, <span class="title class_">PinningTrustManager</span>, <span class="title class_">SSLCertificateChecker</span>,</span><br><span class="line"></span><br><span class="line">    <span class="title class_">SSLContext</span>, <span class="title class_">TrustManagerImpl</span>, X509TrustManager,</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./types&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">byPassSSLPinning</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sslContextEmptyTrustManager = (): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -- Sample Java</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// &quot;Generic&quot; TrustManager Example</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TrustManager[] trustAllCerts = new TrustManager[] &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     new X509TrustManager() &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         public java.security.cert.X509Certificate[] getAcceptedIssuers() &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//             return null;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         public void checkClientTrusted(X509Certificate[] certs, String authType) &#123;  &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         public void checkServerTrusted(X509Certificate[] certs, String authType) &#123;  &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// SSLContext sslcontect = SSLContext.getInstance(&quot;TLS&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sslcontect.init(null, trustAllCerts, null);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">x509TrusManager</span>: X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.X509TrustManager&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">sSLContext</span>: <span class="title class_">SSLContext</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.net.ssl.SSLContext&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Some &#x27;anti-frida&#x27; detections will scan /proc/&lt;pid&gt;/maps.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Rename the tempFileNaming prefix as this could end up in maps.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// https://github.com/frida/frida-java-bridge/blob/8b3790f7489ff5be7b19ddaccf5149d4e7738460/lib/class-factory.js#L94</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">tempFileNaming</span>.<span class="property">prefix</span> == <span class="string">&#x27;frida&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">tempFileNaming</span>.<span class="property">prefix</span> = <span class="string">&#x27;onetwothree&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Implement a new TrustManager</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ref: https://gist.github.com/oleavr/3ca67a173ff7d207c6b8c3b0ca65a9d8</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">TrustManager</span>: X509TrustManager = <span class="title class_">Java</span>.<span class="title function_">registerClass</span>(&#123;</span><br><span class="line"></span><br><span class="line">                <span class="attr">implements</span>: [x509TrusManager],</span><br><span class="line"></span><br><span class="line">                <span class="attr">methods</span>: &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// tslint:disable-next-line:no-empty</span></span><br><span class="line"></span><br><span class="line">                    <span class="title function_">checkClientTrusted</span>(<span class="params">chain, authType</span>) &#123; &#125;,</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// tslint:disable-next-line:no-empty</span></span><br><span class="line"></span><br><span class="line">                    <span class="title function_">checkServerTrusted</span>(<span class="params">chain, authType</span>) &#123; &#125;,</span><br><span class="line"></span><br><span class="line">                    <span class="title function_">getAcceptedIssuers</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// todo 这个是干嘛的</span></span><br><span class="line"></span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;com.sensepost.test.TrustManager&quot;</span>,</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare the TrustManagers array to pass to SSLContext.init()</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">TrustManagers</span>: X509TrustManager[] = [<span class="title class_">TrustManager</span>.$new()];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get a handle on the init() on the SSLContext class</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">SSLContextInit</span> = sSLContext.<span class="property">init</span>.<span class="title function_">overload</span>(</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;[Ljavax.net.ssl.KeyManager;&quot;</span>, <span class="string">&quot;[Ljavax.net.ssl.TrustManager;&quot;</span>, <span class="string">&quot;java.security.SecureRandom&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Override the init method, specifying our new TrustManager</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">SSLContextInit</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">keyManager: <span class="built_in">any</span>, trustManager: <span class="built_in">any</span>, secureRandom: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="title class_">SSLContextInit</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, keyManager, <span class="title class_">TrustManagers</span>, secureRandom);</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">SSLContextInit</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> okHttp3CertificatePinnerCheck = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -- Sample Java</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example used to test this bypass.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// String hostname = &quot;swapi.co&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CertificatePinner certificatePinner = new CertificatePinner.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .add(hostname, &quot;sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// OkHttpClient client = new OkHttpClient.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .certificatePinner(certificatePinner)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Request request = new Request.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .url(&quot;https://swapi.co/api/people/1&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Response response = client.newCall(request).execute();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">certificatePinner</span>: <span class="title class_">CertificatePinner</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">CertificatePinnerCheck</span> = certificatePinner.<span class="property">check</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;java.util.List&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">CertificatePinnerCheck</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">CertificatePinnerCheck</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> okHttp3CertificatePinnerCheckOkHttp = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -- Sample Java</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example used to test this bypass.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// String hostname = &quot;swapi.co&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CertificatePinner certificatePinner = new CertificatePinner.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .add(hostname, &quot;sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// OkHttpClient client = new OkHttpClient.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .certificatePinner(certificatePinner)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Request request = new Request.Builder()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .url(&quot;https://swapi.co/api/people/1&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//         .build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Response response = client.newCall(request).execute();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">certificatePinner</span>: <span class="title class_">CertificatePinner</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.CertificatePinner&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">CertificatePinnerCheckOkHttp</span> = certificatePinner.<span class="property">check$okhttp</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;u15&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">CertificatePinnerCheckOkHttp</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">CertificatePinnerCheckOkHttp</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> appceleratorTitaniumPinningTrustManager = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">pinningTrustManager</span>: <span class="title class_">PinningTrustManager</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;appcelerator.https.PinningTrustManager&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">PinningTrustManagerCheckServerTrusted</span> = pinningTrustManager.<span class="property">checkServerTrusted</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">PinningTrustManagerCheckServerTrusted</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">PinningTrustManagerCheckServerTrusted</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android 7+ TrustManagerImpl.verifyChain()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work in the following NCC blog post was a great help for this hook!</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hattip @AdriVillaB :)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://www.nccgroup.trust/uk/about-us/newsroom-and-events/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  blogs/2017/november/bypassing-androids-network-security-configuration/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// More information: https://sensepost.com/blog/2018/tip-toeing-past-android-7s-network-security-configuration/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> trustManagerImplVerifyChainCheck = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">trustManagerImpl</span>: <span class="title class_">TrustManagerImpl</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.org.conscrypt.TrustManagerImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// https://github.com/google/conscrypt/blob/c88f9f55a523f128f0e4dace76a34724bfa1e88c/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//  platform/src/main/java/org/conscrypt/TrustManagerImpl.java#L650</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">TrustManagerImplverifyChain</span> = trustManagerImpl.<span class="property">verifyChain</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">TrustManagerImplverifyChain</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">untrustedChain: <span class="built_in">any</span>, trustAnchorChain: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">                host: <span class="built_in">any</span>, clientAuth: <span class="built_in">any</span>, ocspData: <span class="built_in">any</span>, tlsSctData: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Skip all the logic and just return the chain again :P</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> untrustedChain;</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">TrustManagerImplverifyChain</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android 7+ TrustManagerImpl.checkTrustedRecursive()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work in the following method is based on:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://techblog.mediaservice.net/2018/11/universal-android-ssl-pinning-bypass-2/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> trustManagerImplCheckTrustedRecursiveCheck = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">arrayList</span>: <span class="title class_">ArrayList</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.ArrayList&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">trustManagerImpl</span>: <span class="title class_">TrustManagerImpl</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.org.conscrypt.TrustManagerImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// https://android.googlesource.com/platform/external/conscrypt/+/1186465/src/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//  platform/java/org/conscrypt/TrustManagerImpl.java#391</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">TrustManagerImplcheckTrustedRecursive</span> = trustManagerImpl.<span class="property">checkTrustedRecursive</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">TrustManagerImplcheckTrustedRecursive</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">certs: <span class="built_in">any</span>, host: <span class="built_in">any</span>, clientAuth: <span class="built_in">any</span>, untrustedChain: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">                trustAnchorChain: <span class="built_in">any</span>, used: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Return an empty list</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> arrayList.$new();</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">TrustManagerImplcheckTrustedRecursive</span>;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> phoneGapSSLCertificateChecker = (): <span class="built_in">any</span> | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wrapJavaPerform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">sslCertificateChecker</span>: <span class="title class_">SSLCertificateChecker</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;nl.xservices.plugins.SSLCertificateChecker&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="title class_">SSLCertificateCheckerExecute</span> = sslCertificateChecker.<span class="property">execute</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="title class_">SSLCertificateCheckerExecute</span>.<span class="title function_">overload</span>(</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;java.lang.String&quot;</span>, <span class="string">&quot;org.json.JSONArray&quot;</span>, <span class="string">&quot;org.apache.cordova.CallbackContext&quot;</span>).<span class="property">implementation</span> =</span><br><span class="line"></span><br><span class="line">                <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">function</span> (<span class="params">str: <span class="built_in">any</span>, jsonArray: <span class="built_in">any</span>, callBackContext: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">                    callBackContext.<span class="title function_">success</span>(<span class="string">&quot;CONNECTION_SECURE&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_">sslContextEmptyTrustManager</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">okHttp3CertificatePinnerCheck</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">okHttp3CertificatePinnerCheckOkHttp</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">appceleratorTitaniumPinningTrustManager</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">trustManagerImplVerifyChainCheck</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">trustManagerImplCheckTrustedRecursiveCheck</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">phoneGapSSLCertificateChecker</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2021/12/30/%E9%92%88%E5%AF%B9Android_App%E9%9A%90%E7%A7%81%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B/" data-id="cl8x7xxbx001le875biyg4la9" data-title="针对Android App隐私信息检测" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Fuzz学习-前置知识" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/10/Fuzz%E5%AD%A6%E4%B9%A0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/" class="article-date">
  <time class="dt-published" datetime="2021-10-10T02:28:25.000Z" itemprop="datePublished">2021-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/10/Fuzz%E5%AD%A6%E4%B9%A0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/">Fuzz学习-前置知识</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="基础的底层知识"><a href="#基础的底层知识" class="headerlink" title="基础的底层知识"></a>基础的底层知识</h2><ul>
<li>学习周期<ul>
<li>3-5周</li>
</ul>
</li>
<li>CSAPP（深入理解计算机系统第三版）<ul>
<li>MOOC地址<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1kE411X7S5">南京大学 计算机系统基础(一)主讲：袁春风老师_哔哩哔哩_bilibili</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1rE41127Re">计算机系统基础（二）南京大学 主讲：袁春风 南京大学_哔哩哔哩_bilibili</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1jE411874k">南京大学 计算机系统基础(三)完整 主讲：袁春风老师_哔哩哔哩_bilibili</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iW411d7hd">【精校中英字幕】2015 CMU 15-213 CSAPP 深入理解计算机系统 课程视频_哔哩哔哩_bilibili</a></li>
</ul>
</li>
<li>课后作业<ul>
<li><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">CS:APP3e, Bryant and O’Hallaron</a></li>
<li><a target="_blank" rel="noopener" href="https://kiprey.github.io/2020/07/csapp-lab-writeup/">作业解答</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Unix编程基础和C语言"><a href="#Unix编程基础和C语言" class="headerlink" title="Unix编程基础和C语言"></a>Unix编程基础和C语言</h2><ul>
<li>学习周期<ul>
<li>可选</li>
</ul>
</li>
<li>这部分主要就是记住一些常见的函数就行了，熟悉管道、共享内存、socket这些常见的进程间通信机制</li>
<li>有兴趣的同学可以专门找《Unix环境高级编程》和《Unix网络编程》看一看，自己实现一个web server <a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/05/WebServer-1/">https://kiprey.github.io/2021/05/WebServer-1/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2021/10/10/Fuzz%E5%AD%A6%E4%B9%A0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/" data-id="cl8x7xxbb0004e87599sbd1i7" data-title="Fuzz学习-前置知识" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-将Frida内置进AOSP中" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/10/%E5%B0%86Frida%E5%86%85%E7%BD%AE%E8%BF%9BAOSP%E4%B8%AD/" class="article-date">
  <time class="dt-published" datetime="2021-10-10T02:28:25.000Z" itemprop="datePublished">2021-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/10/%E5%B0%86Frida%E5%86%85%E7%BD%AE%E8%BF%9BAOSP%E4%B8%AD/">将Frida内置进AOSP中</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>将Frida内置进AOSP中</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>系统：Ubuntu20</li>
<li>aosp版本：10r2</li>
<li>下载最新的ndk lts，我选择22，我选择最新的lts版本，在make的时候可能会要求让你选择22，所以选择lts的上一个版本即可。</li>
<li>确保GCC的版本在7.5以上</li>
<li>相应的工具链要在PATH中，比如ptython3,Node.JS</li>
</ul>
<h2 id="编译frida"><a href="#编译frida" class="headerlink" title="编译frida"></a>编译frida</h2><p>下载相应的库：</p>
<blockquote>
<p>sudo apt-get install build-essential curl git lib32stdc++-9-dev ibc6-dev-i386 nodejs npm python3-dev python3-pip gcc-multilib g++-multilib</p>
</blockquote>
<p>将NDK加入到环境变量中:</p>
<blockquote>
<p>Export ANDROID_NDK_ROOT&#x3D;your_ndk_path</p>
</blockquote>
<blockquote>
<p>Export PATH&#x3D;$ANDROID_NDK_ROOT:$PATH</p>
</blockquote>
<p>下载frida源码：</p>
<blockquote>
<p>git clone –recurse-submodules <a target="_blank" rel="noopener" href="https://github.com/frida/frida.git">https://github.com/frida/frida.git</a></p>
</blockquote>
<p>官方<code>toolchain</code>和<code>sdk</code>下载地址如下</p>
<p>其中<code>20210123</code>是<code>frida</code>中<code>releng/deps.mk</code>中的<code>frida_deps_version</code></p>
<p>后面部分则是<code>toolchain-&#123;平台+架构&#125;.tar.bz2</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://build.frida.re/deps/20210123/toolchain-linux-x86_64.tar.bz2">https://build.frida.re/deps/20210123/toolchain-linux-x86_64.tar.bz2</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://build.frida.re/deps/20210123/sdk-linux-x86_64.tar.bz2">https://build.frida.re/deps/20210123/sdk-linux-x86_64.tar.bz2</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://build.frida.re/deps/20210123/sdk-android-arm.tar.bz2">https://build.frida.re/deps/20210123/sdk-android-arm.tar.bz2</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://build.frida.re/deps/20210123/sdk-android-arm64.tar.bz2">https://build.frida.re/deps/20210123/sdk-android-arm64.tar.bz2</a></p>
</blockquote>
<p>可以手动下载上面的文件，然后在<code>frida</code>的文件夹下新建<code>build</code>文件夹</p>
<p>然后将文件放入build即可</p>
<p>现在执行<code>releng/setup-env.sh</code></p>
<p>不过个人认为手动方便一点，因为编译时的网络访问问题真的烦人（省略N字）</p>
<p>编译frida：</p>
<blockquote>
<p>make core-android-arm64</p>
</blockquote>
<p>编译成功：</p>
<p><img src="/2021/10/10/%E5%B0%86Frida%E5%86%85%E7%BD%AE%E8%BF%9BAOSP%E4%B8%AD/1.png"></p>
<h2 id="编译AOSP10"><a href="#编译AOSP10" class="headerlink" title="编译AOSP10"></a>编译AOSP10</h2><p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1MYTdT4pxMo8vsq5CxPFVZg">https://pan.baidu.com/s/1MYTdT4pxMo8vsq5CxPFVZg</a> </p>
<p>提取码：yuov</p>
<p>下载aosp 10 源码。</p>
<p>解压后，下载驱动文件：<a target="_blank" rel="noopener" href="https://developers.google.com/android/drivers#sailfishqp1a.190711.020">https://developers.google.com/android/drivers#sailfishqp1a.190711.020</a></p>
<p>再执行驱动文件即可。</p>
<p>下载相应的库：</p>
<blockquote>
<p>sudo apt-get install -y openjdk-8-jdk</p>
</blockquote>
<blockquote>
<p>sudo apt-get install git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc unzip</p>
</blockquote>
<h4 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h4><blockquote>
<p>source build&#x2F;envsetup.sh </p>
</blockquote>
<blockquote>
<p>lunch</p>
</blockquote>
<blockquote>
<p>选择好对应的版本就进行编译</p>
</blockquote>
<blockquote>
<p>M</p>
</blockquote>
<p>如果出现如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[ 37% 50/135] test github.com/google/blueprint/pathtools</span><br><span class="line">FAILED: out/soong/.bootstrap/blueprint-pathtools/test/test.passed</span><br><span class="line">out/soong/.bootstrap/bin/gotestrunner -p ./build/blueprint/pathtools -f out/soong/.bootstrap/blueprint-pathtools/test/test.passed -- out/soong/.bootstrap/blueprint-pathtools/test/test -test.short</span><br><span class="line">--- FAIL: TestGlobEscapes (0.00s)</span><br><span class="line"> --- FAIL: TestGlobEscapes//* (0.00s)</span><br><span class="line"> glob_test.go:562: incorrect matches list:</span><br><span class="line"> glob_test.go:562: pattern: &quot;/&quot;</span><br><span class="line"> glob_test.go:562: got: []string&#123;&quot;/&quot;, &quot;a/&quot;, &quot;b&quot;, &quot;/a&quot;, &quot;/b/&quot;, &quot;/b/b&quot;, &quot;a/a&quot;&#125;</span><br><span class="line"> glob_test.go:562: expected: []string&#123;&quot;&quot;, &quot;/&quot;, &quot;?&quot;, &quot;a/&quot;, &quot;b&quot;, &quot;/&quot;, &quot;/a&quot;, &quot;/b/&quot;, &quot;/b/b&quot;, &quot;a/a&quot;&#125;</span><br><span class="line"> --- FAIL: TestGlobEscapes//* (0.00s)</span><br><span class="line"> glob_test.go:562: incorrect matches list:</span><br><span class="line"> glob_test.go:562: pattern: &quot;/\&quot;</span><br><span class="line"> glob_test.go:562: got: []string(nil)</span><br><span class="line"> glob_test.go:562: expected: []string&#123;&quot;&quot;, &quot;/&quot;&#125;</span><br><span class="line"> --- FAIL: TestGlobEscapes/**/* (0.00s)</span><br><span class="line"> glob_test.go:562: incorrect matches list:</span><br><span class="line"> glob_test.go:562: pattern: &quot;\\/&quot;</span><br><span class="line"> glob_test.go:562: got: []string&#123;&quot;/a&quot;, &quot;/b/&quot;&#125;</span><br><span class="line"> glob_test.go:562: expected: []string&#123;&quot;/&quot;, &quot;/a&quot;, &quot;/b/&quot;&#125;</span><br><span class="line"> --- FAIL: TestGlobEscapes/**//* (0.00s)</span><br><span class="line"> glob_test.go:562: incorrect matches list:</span><br><span class="line"> glob_test.go:562: pattern: &quot;\\//&quot;</span><br><span class="line"> glob_test.go:562: got: []string&#123;&quot;/a&quot;, &quot;/b/&quot;, &quot;/b/b&quot;&#125;</span><br><span class="line"> glob_test.go:562: expected: []string&#123;&quot;/&quot;, &quot;/a&quot;, &quot;/b/&quot;, &quot;/b/b&quot;&#125;</span><br><span class="line">FAIL</span><br><span class="line">05:04:52 soong bootstrap failed with: exit status 1</span><br></pre></td></tr></table></figure>

<p>该错误应该是源码问题，所以我后来使用repo重新同步了一次源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 创建bin目录</span><br><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:$PATH</span><br><span class="line">// 下载repo启动器</span><br><span class="line">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br><span class="line">// 创建AOSP源码目录 </span><br><span class="line">mkdir aosp10r2</span><br><span class="line">cd aosp10r2</span><br><span class="line">// 初始化源码仓库, 选择与设备对应的源码tag版本</span><br><span class="line">repo init -u https://android.googlesource.com/platform/manifest -b android-10.0.0_r2</span><br><span class="line">// 下载</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<p>我这边是挂梯子下载的，速度还行，如果不行请使用清华园或者是中科大。北清华、南科大。</p>
<blockquote>
<p>编译</p>
</blockquote>
<blockquote>
<p>M -j8</p>
</blockquote>
<h2 id="修改AOSP10r2源码将frida内置"><a href="#修改AOSP10r2源码将frida内置" class="headerlink" title="修改AOSP10r2源码将frida内置"></a>修改AOSP10r2源码将frida内置</h2><h3 id="方案一，使用frida-gadget配合config文件来做配合。"><a href="#方案一，使用frida-gadget配合config文件来做配合。" class="headerlink" title="方案一，使用frida-gadget配合config文件来做配合。"></a>方案一，使用frida-gadget配合config文件来做配合。</h3><p>根据gadget官网文档中描述的，该方案已经被人利用成功过，所以直接站在巨人的肩膀上可以省力不少，其次，该方案不需要root权限，对于内置frida来说很方便，因为root这个权限也是相当危险的。</p>
<h3 id="方案二，userdebug模式，将frida内置到系统中"><a href="#方案二，userdebug模式，将frida内置到系统中" class="headerlink" title="方案二，userdebug模式，将frida内置到系统中"></a>方案二，userdebug模式，将frida内置到系统中</h3><p>将编译完成的frida-gadget.so拷贝出来，放到aosp10r2&#x2F;out&#x2F;target&#x2F;product&#x2F;sailfish&#x2F;system&#x2F;lib64&#x2F;下</p>
<p>如果是32位的gadget，就放到aosp10r2&#x2F;out&#x2F;target&#x2F;product&#x2F;sailfish&#x2F;system&#x2F;lib&#x2F;下，并都添加lib前缀。</p>
<p>其次还需要配置config文件，文件名为libfrida-gadget.config.so，lib开头，config.so结尾，中间的名字按照放到lib下的firda文件名来确定，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;interaction&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;listen&quot;,</span><br><span class="line">    &quot;address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;port&quot;: 27042,</span><br><span class="line">    &quot;on_load&quot;: &quot;resume&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>64位frida-gadget.so在frida&#x2F;build&#x2F;frida-android-arm64&#x2F;lib&#x2F;frida&#x2F;64&#x2F;frida-gadget.so</p>
<p>修改aosp&#x2F;framework&#x2F;base&#x2F;core&#x2F;jni&#x2F;com_android_internal_os_Zygote.cpp中的com_android_internal_os_Zygote_nativeForkAndSpecialize函数，以及需要在文件上面添加#include &lt;dlfcn.h&gt;，导入dlopen相关函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">static jint com_android_internal_os_Zygote_nativeForkAndSpecialize(</span><br><span class="line">        JNIEnv* env, jclass, jint uid, jint gid, jintArray gids,</span><br><span class="line">        jint runtime_flags, jobjectArray rlimits,</span><br><span class="line">        jint mount_external, jstring se_info, jstring nice_name,</span><br><span class="line">        jintArray managed_fds_to_close, jintArray managed_fds_to_ignore, jboolean is_child_zygote,</span><br><span class="line">        jstring instruction_set, jstring app_data_dir) &#123;</span><br><span class="line">    jlong capabilities = CalculateCapabilities(env, uid, gid, gids, is_child_zygote);</span><br><span class="line"></span><br><span class="line">    if (UNLIKELY(managed_fds_to_close == nullptr)) &#123;</span><br><span class="line">      ZygoteFailure(env, &quot;zygote&quot;, nice_name, &quot;Zygote received a null fds_to_close vector.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;int&gt; fds_to_close =</span><br><span class="line">        ExtractJIntArray(env, &quot;zygote&quot;, nice_name, managed_fds_to_close).value();</span><br><span class="line">    std::vector&lt;int&gt; fds_to_ignore =</span><br><span class="line">        ExtractJIntArray(env, &quot;zygote&quot;, nice_name, managed_fds_to_ignore)</span><br><span class="line">            .value_or(std::vector&lt;int&gt;());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;int&gt; usap_pipes = MakeUsapPipeReadFDVector();</span><br><span class="line"></span><br><span class="line">    fds_to_close.insert(fds_to_close.end(), usap_pipes.begin(), usap_pipes.end());</span><br><span class="line">    fds_to_ignore.insert(fds_to_ignore.end(), usap_pipes.begin(), usap_pipes.end());</span><br><span class="line"></span><br><span class="line">    fds_to_close.push_back(gUsapPoolSocketFD);</span><br><span class="line"></span><br><span class="line">    if (gUsapPoolEventFD != -1) &#123;</span><br><span class="line">      fds_to_close.push_back(gUsapPoolEventFD);</span><br><span class="line">      fds_to_ignore.push_back(gUsapPoolEventFD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pid_t pid = ForkCommon(env, false, fds_to_close, fds_to_ignore);</span><br><span class="line"></span><br><span class="line">    if (pid == 0) &#123;</span><br><span class="line">      SpecializeCommon(env, uid, gid, gids, runtime_flags, rlimits,</span><br><span class="line">                       capabilities, capabilities,</span><br><span class="line">                       mount_external, se_info, nice_name, false,</span><br><span class="line">                       is_child_zygote == JNI_TRUE, instruction_set, app_data_dir);</span><br><span class="line">      #if defined(__arm__) || defined(__arm64__)</span><br><span class="line">        &#123;</span><br><span class="line">            #if defined(__arm__)</span><br><span class="line">                #define FRIDA_LIB &quot;/system/lib/libfrida-gadget_arm_32.so&quot;</span><br><span class="line">            #else</span><br><span class="line">                #define FRIDA_LIB &quot;/system/lib64/libfrida-gadget_arm_64.so&quot;</span><br><span class="line">            #endif</span><br><span class="line">            const char *name = env-&gt;GetStringUTFChars(nice_name, 0);</span><br><span class="line">            void* frida = dlopen(FRIDA_LIB, RTLD_NOW);</span><br><span class="line">            if(NULL == frida) &#123;</span><br><span class="line">                ALOGE(&quot;(%s) load frida-gadget(%s) failed, err= %d\n&quot;, name, FRIDA_LIB, errno);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ALOGI(&quot;(%s) load frida-gadget(%s) success\n&quot;, name, FRIDA_LIB);</span><br><span class="line">            &#125;</span><br><span class="line">            env-&gt;ReleaseStringUTFChars(nice_name, name);</span><br><span class="line">        &#125;</span><br><span class="line">       #endif </span><br><span class="line">    &#125;</span><br><span class="line">    return pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h4><p>Frida-ps -U没问题，但是firda -UF 会有问题。</p>
<p><img src="/2021/10/10/%E5%B0%86Frida%E5%86%85%E7%BD%AE%E8%BF%9BAOSP%E4%B8%AD/2.png"></p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.mobibrw.com/2021/28588">https://www.mobibrw.com/2021/28588</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-266767.htm">https://bbs.pediy.com/thread-266767.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://frida.re/docs/building/">https://frida.re/docs/building/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.seeflower.dev/archives/16/">https://blog.seeflower.dev/archives/16/</a></li>
<li><a target="_blank" rel="noopener" href="http://qiushao.net/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/">http://qiushao.net/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</a></li>
<li><a target="_blank" rel="noopener" href="http://gityuan.com/2016/03/26/app-process-create/">http://gityuan.com/2016/03/26/app-process-create/</a></li>
<li><a target="_blank" rel="noopener" href="http://mouxuejie.com/blog/2019-11-17/aosp-setup/">http://mouxuejie.com/blog/2019-11-17/aosp-setup/</a></li>
<li><a target="_blank" rel="noopener" href="https://note.youdao.com/ynoteshare/index.html?id=380a0a8b06ac89758563ae415f27ee1e&amp;type=note&amp;_time=1632623346665">https://note.youdao.com/ynoteshare/index.html?id=380a0a8b06ac89758563ae415f27ee1e&amp;type=note&amp;_time=1632623346665</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268256.htm">https://bbs.pediy.com/thread-268256.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://www.frida.re/docs/gadget/">https://www.frida.re/docs/gadget/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2021/10/10/%E5%B0%86Frida%E5%86%85%E7%BD%AE%E8%BF%9BAOSP%E4%B8%AD/" data-id="cl8x7xxbp000we875hxsuhy6c" data-title="将Frida内置进AOSP中" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-研究SandHook" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/09/%E7%A0%94%E7%A9%B6SandHook/" class="article-date">
  <time class="dt-published" datetime="2021-09-09T02:28:25.000Z" itemprop="datePublished">2021-09-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/09/09/%E7%A0%94%E7%A9%B6SandHook/">研究SandHook</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>SandHook的实现介绍：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ganyao939543405/article/details/86661040">Android ART Hook 实现 - SandHook_ganyao939543405的博客-CSDN博客_sandhook</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/asLody/SandHook/blob/master/doc/doc.md">SandHook&#x2F;doc.md at master · asLody&#x2F;SandHook</a></p>
<p>其中有一个重要的点就是，android内部实现java对象的时候会有一个mirror的镜像对象，有一些虚拟机比较在意的类型，例如 Class，Method 这些 Art 内部所需要的类型，他们在 mirror 中是有对应的类型的。</p>
<p>ART在进行JIT&#x2F;AOT的时候，会对dex代码进行二次编译的过程，也就是将原本的java class、method全都转化成mirror:class、mirror:method。</p>
<p>AOSP源码：<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/art/+/8db4a405fe283d8769d5f38299d8692c009feb1a/runtime/mirror">https://android.googlesource.com/platform/art/+/8db4a405fe283d8769d5f38299d8692c009feb1a/runtime/mirror</a></p>
<p>这篇文章说的比较详细：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903999125061639">脱了马甲我也认识你: 聊聊 Android 中类的真实形态 - 掘金</a></p>
<p>Sandhook 作者写的文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ganyao939543405/article/details/87885893#t7">SandHook 第三弹 - 性能优化 &amp; Xposed 模块 &amp; 阻止 VM Inline_ganyao939543405的博客-CSDN博客</a></p>
<p>他遇到的一个问题就是VM Inline会将一定阈值内的代码进行优化，这样就会阻碍sandhook的hook过程，他的解决方法也是通过调整这个阈值来做处理。那我们来考虑，我们能不能实现改阈值将该优化的都优化了，导致他hook失败呢。</p>
<p>跳转图：<br><img src="/2021/09/09/%E7%A0%94%E7%A9%B6SandHook/1.png"></p>
<p>非root注入：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ganyao114/SandBoxHookPlugin">https://github.com/ganyao114/SandBoxHookPlugin</a></p>
<p>沙箱环境的一种注入，是不是跟这个黑产工具类似呢。</p>
<p>整个的攻击逻辑就是将apk下载到本地，黑产工具对他进行二次打包和插入dex指令集代码（或者不用插入，直接sandhook修改就行。），但是apk中安装到手机上的是存在sandhook的，不知道是为什么，可能跟下面这段代码一样吧，就是对某一个类进行hook操作（那么这个操作可能是对人脸识别的）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SandHookConfig.libSandHookPath = soNewPath;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    SandHook.<span class="built_in">addHookClass</span>(ActivityHooker.<span class="keyword">class</span>);</span><br><span class="line">&#125; <span class="built_in">catch</span> (HookErrorException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我觉得最主要的就是对sandhook的检测，他暴露很多特征，诸如修改那个阈值为0来做到组织inline的优化，还有类似的（如果可以的话，我们自己动手去修改这个值，再去检测这个值，或者直接检测这个值，如果这个值为0，那么就判断为存在hook的情况[sandhook]，sandhook中并没有使用这个，其中关键特征<code>_ZN3art3jit3Jit20jit_compiler_handle_E</code> 并没有使用，<a target="_blank" rel="noopener" href="https://github.com/asLody/SandHook/blob/16a59fa0eef011ca202814311b362a8a3bcda412/hooklib/src/main/cpp/utils/hide_api.cpp#L93%EF%BC%89">https://github.com/asLody/SandHook/blob/16a59fa0eef011ca202814311b362a8a3bcda412/hooklib/src/main/cpp/utils/hide_api.cpp#L93）</a><br>其次就是他的跳转逻辑中会mmap一段可执行的区域，那么能不能通过之前写的判断smaps中的信息来做到检测呢（这部分验证需要自己写一个sandhook的demo来做）。</p>
<p>其中对_ZN3art3jit3Jit20jit_compiler_handle_E做处理的是这些函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">globalJitCompileHandlerAddr = <span class="built_in">reinterpret_cast</span>&lt;art::jit::JitCompiler **&gt;(<span class="built_in">getSymCompat</span>(art_lib_path, <span class="string">&quot;_ZN3art3jit3Jit20jit_compiler_handle_E&quot;</span>));</span><br><span class="line"></span><br><span class="line">art::<span class="function">jit::JitCompiler* <span class="title">getGlobalJitCompiler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SDK_INT &lt; ANDROID_N)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (globalJitCompileHandlerAddr == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> *globalJitCompileHandlerAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">art::CompilerOptions* <span class="title">getGlobalCompilerOptions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getCompilerOptions</span>(<span class="built_in">getGlobalJitCompiler</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">art::CompilerOptions* <span class="title">getCompilerOptions</span><span class="params">(art::jit::JitCompiler* compiler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compiler == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> compiler-&gt;compilerOptions.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jboolean JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_swift_sandhook_SandHook_disableVMInline</span><span class="params">(JNIEnv *env, jclass type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SDK_INT &lt; ANDROID_N)</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    <span class="built_in">replaceUpdateCompilerOptionsQ</span>();</span><br><span class="line">    art::CompilerOptions* compilerOptions = <span class="built_in">getGlobalCompilerOptions</span>();</span><br><span class="line">    <span class="keyword">if</span> (compilerOptions == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;jboolean&gt;(<span class="built_in">disableJitInline</span>(compilerOptions));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">disableJitInline</span><span class="params">(art::CompilerOptions* compilerOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compilerOptions == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">size_t</span> originOptions = compilerOptions-&gt;<span class="built_in">getInlineMaxCodeUnits</span>();</span><br><span class="line">    <span class="comment">//maybe a real inlineMaxCodeUnits</span></span><br><span class="line">    <span class="keyword">if</span> (originOptions &gt; <span class="number">0</span> &amp;&amp; originOptions &lt;= <span class="number">1024</span>) &#123;</span><br><span class="line">        compilerOptions-&gt;<span class="built_in">setInlineMaxCodeUnits</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通过dlsym进行拿到获取。dlsym可能会被hook，还是需要自己实现一套。</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tugohost.github.io.com/2021/09/09/%E7%A0%94%E7%A9%B6SandHook/" data-id="cl8x7xxbq000ze8750px73yfa" data-title="研究SandHook" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LLVM/" rel="tag">LLVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9E%8E%E6%8A%98%E8%85%BE/" rel="tag">瞎折腾</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/C/" style="font-size: 12.5px;">C++</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Golang/" style="font-size: 17.5px;">Golang</a> <a href="/tags/LLVM/" style="font-size: 15px;">LLVM</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 10px;">安全</a> <a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">漏洞</a> <a href="/tags/%E7%9E%8E%E6%8A%98%E8%85%BE/" style="font-size: 10px;">瞎折腾</a> <a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 20px;">逆向</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/06/KUbuntu%2020%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">KUbuntu20 环境配置</a>
          </li>
        
          <li>
            <a href="/2022/06/09/LLVM_IR%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">LLVM从小白到放弃（三）- LLVM IR概述与常用指令</a>
          </li>
        
          <li>
            <a href="/2022/06/08/LLVM_Pass/">LLVM从小白到放弃（二）- LLVM Pass</a>
          </li>
        
          <li>
            <a href="/2022/04/22/Android%E5%8A%A0%E8%BD%BDSO%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B/">Android加载SO整个流程</a>
          </li>
        
          <li>
            <a href="/2022/04/14/LLVM%E6%A6%82%E8%BF%B0%E4%B8%8ELLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">LLVM从小白到放弃（一）- LLVM概述与LLVM环境搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 TUGOhost<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>