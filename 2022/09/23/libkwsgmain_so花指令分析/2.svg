<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1203px" height="895px" viewBox="-0.5 -0.5 1203 895"><defs/><g><path d="M 136 76 L 136 119.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 124.88 L 132.5 117.88 L 136 119.63 L 139.5 117.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="16" width="120" height="60" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 46px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><b>bytehook_hook_single</b></div></div></div></foreignObject></g><path d="M 136 186 L 136 219.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 224.88 L 132.5 217.88 L 136 219.63 L 139.5 217.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="126" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 156px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">bh_core_hook_single</div></div></div></foreignObject></g><path d="M 136 286 L 136 319.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 324.88 L 132.5 317.88 L 136 319.63 L 139.5 317.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="226" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 256px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">bh_task_create_single<br />创建新的任务</div></div></div></foreignObject></g><path d="M 136 386 L 136 424.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 429.88 L 132.5 422.88 L 136 424.63 L 139.5 422.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="326" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 356px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><pre style="background-color:#ffffff;color:#080808;font-family:'JetBrains Mono',monospace;font-size:11.3pt;">bh_task_manager_add</pre><pre style="background-color:#ffffff;color:#080808;font-family:'JetBrains Mono',monospace;font-size:11.3pt;">将新创建的task加入到task_manager</pre></div></div></div></foreignObject></g><path d="M 296 207 L 246 207 L 246 305 L 296 305" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 196 256 L 246 256" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="246" y="225" width="190" height="80" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 188px; height: 1px; padding-top: 265px; margin-left: 248px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><font style="font-size: 12px;">1.创建新的任务，检测是否创建失败<br />2.设置任务的type为<span style="background-color: rgb(255, 255, 255);"><font style="font-style: italic; font-size: 12px;" face="JetBrains Mono, monospace" color="#871094">BH_TASK_TYPE_SINGLE</font><br />3.设置任务的status为</span></font><span style="background-color: rgb(255, 255, 255);"><font style="font-size: 12px;"><font style="color: rgb(135, 16, 148); font-style: italic; font-size: 12px;" face="JetBrains Mono, monospace">BH_TASK_STATUS_UNFINISHED</font><br />4.设置任务的caller_path_name为设置libhookee.so 也就是hook的目标so</font><br /></span></div></div></div></foreignObject></g><path d="M 136 491 L 136 511 L 136 506 L 136 519.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 524.88 L 132.5 517.88 L 136 519.63 L 139.5 517.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="431" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 461px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><pre style="background-color:#ffffff;color:#080808;font-family:'JetBrains Mono',monospace;font-size:11.3pt;"><pre style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 11.3pt;">bh_task_manager_hook</pre></pre></div></div></div></foreignObject></g><path d="M 326 412 L 276 412 L 276 510 L 326 510" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 226 461 L 276 461" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="276" y="426" width="210" height="94" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 208px; height: 1px; padding-top: 473px; margin-left: 278px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.dl监控是否已经初始化，没有初始化就初始化<br />2.对当前进程进行加锁<br />3.监控dlopen、dlclsoe<br />4.新建一个elf_mgr，用来管理elf文件<br />5.执行hook<br />6.撤销对dlopen、dlclose的监控<br />7.设置相应的状态</div></div></div></foreignObject></g><path d="M 576 426 L 526 426 L 526 524 L 576 524" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 476 475 L 526 475" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="526" y="426" width="210" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 208px; height: 1px; padding-top: 476px; margin-left: 528px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.加锁<br />2.遍历ELFs<br />3.清理不在linker中的solist的ELF</div></div></div></foreignObject></g><path d="M 526 595 L 381 595 L 381 526.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 381 521.12 L 384.5 528.12 L 381 526.37 L 377.5 528.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 576 546 L 526 546 L 526 644 L 576 644" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="526" y="546" width="200" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 198px; height: 1px; padding-top: 596px; margin-left: 528px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.hook前置设置<br />2.执行hook</div></div></div></foreignObject></g><path d="M 716 536 L 666 536 L 666 634 L 716 634" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 616 585 L 666 585" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="666" y="536" width="170" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 168px; height: 1px; padding-top: 586px; margin-left: 668px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.找到callee_addr，也就是相应的so的方法对应的地址，比如hook open函数，找的可能就是libdl.so</div></div></div></foreignObject></g><path d="M 666 705 L 626 705 L 626 652.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 626 647.12 L 629.5 654.12 L 626 652.37 L 622.5 654.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 716 656 L 666 656 L 666 754 L 716 754" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="666" y="656" width="170" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 168px; height: 1px; padding-top: 706px; margin-left: 668px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.从elf_mgr中找到caller_path_name叫caller_elf<br />2.如果caller_elf不为空就对caller_elf执行hook</div></div></div></foreignObject></g><path d="M 816 815 L 751 815 L 751 762.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 751 757.12 L 754.5 764.12 L 751 762.37 L 747.5 764.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 866 766 L 816 766 L 816 864 L 866 864" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="816" y="796" width="370" height="50" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 368px; height: 1px; padding-top: 821px; margin-left: 818px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">1.检查elf文件格式，是否为正确的elf文件<br />2.面对不同的android版本以及ABI执行不一样的路径，这里以LP64、大于androidO为例<br />3.锁住目标elf文件，这里是libdl.so<br />4.执行hook<br />5.获取elf的got表地址<br />6.对got表地址进行hook<br />7.将elf的got的函数地址替换为跳板所指向的地址，这样就<font color="#ff3333">完成了hook</font><br /></div></div></div></foreignObject></g><path d="M 136 586 L 136 606 L 136 586 L 136 599.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 136 604.88 L 132.5 597.88 L 136 599.63 L 139.5 597.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="76" y="526" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 556px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><pre style="background-color:#ffffff;color:#080808;font-family:'JetBrains Mono',monospace;font-size:11.3pt;">bh_recorder_add_hook</pre><pre style="background-color:#ffffff;color:#080808;font-family:'JetBrains Mono',monospace;font-size:11.3pt;">对hook进行记录</pre></div></div></div></foreignObject></g><rect x="76" y="606" width="120" height="60" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 636px; margin-left: 77px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">结束</div></div></div></foreignObject></g></g></svg>